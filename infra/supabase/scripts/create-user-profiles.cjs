const { Client } = require('pg')

const connStr = process.env.SUPABASE_CONNECTION_STRING || process.env.SUPABASE_DB_URL || ''
if (!connStr) {
  console.error('缺少 SUPABASE_CONNECTION_STRING 或 SUPABASE_DB_URL')
  process.exit(1)
}

const statements = [
  `CREATE TABLE IF NOT EXISTS public.user_profiles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    wallet_address TEXT NOT NULL UNIQUE,
    username TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    CONSTRAINT user_profiles_username_len CHECK (char_length(username) BETWEEN 3 AND 32),
    CONSTRAINT user_profiles_username_chars CHECK (username ~ '^[A-Za-z0-9_.-]+$')
  );`,
  `CREATE INDEX IF NOT EXISTS user_profiles_wallet_address_idx ON public.user_profiles (wallet_address);`
]

async function main() {
  const client = new Client({ connectionString: connStr })
  try {
    await client.connect()
    for (let i = 0; i < statements.length; i++) {
      const sql = statements[i]
      process.stdout.write(`执行语句 ${i + 1}/${statements.length}: ${sql}\n`)
      await client.query(sql)
    }
    console.log('user_profiles 表创建完成')
  } catch (err) {
    console.error('创建失败:', err?.message || err)
    process.exit(1)
  } finally {
    try { await client.end() } catch {}
  }
}

main().catch((e) => { console.error(e); process.exit(2) })