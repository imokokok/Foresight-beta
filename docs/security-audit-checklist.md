# Relayer 服务安全审计清单

本文档提供 Foresight Relayer 服务的安全审计指南，用于团队内部评估和外部审计参考。

## 审计范围

本清单涵盖以下模块的安全检查：
- 订单验证与撮合引擎
- 批量结算系统
- 账户抽象（AA）集成
- API 路由与认证
- 数据库交互
- Redis 缓存操作
- 集群与消息传递

---

## 一、认证与授权

### 1.1 API 密钥管理

- [ ] API 密钥生成算法是否使用密码学安全的随机数生成器
- [ ] API 密钥是否在存储前进行哈希处理
- [ ] API 密钥是否设置了过期时间
- [ ] 是否实现了密钥轮换机制
- [ ] 密钥验证失败是否有速率限制
- [ ] 日志中是否泄露了密钥信息

**测试命令：**
```bash
# 检查密钥存储方式
grep -r "apikey" services/relayer/src/ --include="*.ts"
```

### 1.2 签名验证

- [ ] EIP-712 签名验证是否正确实现
- [ ] 签名是否验证了所有必要字段（maker, amount, price, salt, expiry）
- [ ] 是否防止了签名重放攻击
- [ ] 签名验证失败是否有适当的错误处理
- [ ] 是否验证签名者的地址格式

**关键文件：**
- `services/relayer/src/matching/orderValidation.ts`
- `services/relayer/src/utils/orderInput.ts`

### 1.3 权限控制

- [ ] 管理 API 是否有额外的权限验证
- [ ] 是否实现了角色-based 访问控制（RBAC）
- [ ] 敏感操作是否需要多因素认证
- [ ] 权限变更是否有审计日志

---

## 二、订单与交易安全

### 2.1 订单验证

- [ ] 是否验证订单的 maker 地址格式
- [ ] 是否验证价格和数量在合理范围内
- [ ] 是否验证订单未过期
- [ ] 是否检查重复订单（基于 salt）
- [ ] 是否验证 TIF（Time In Force）参数
- [ ] 是否防止价格操纵攻击

**关键文件：**
- `services/relayer/src/matching/orderValidation.ts`
- `services/relayer/src/matching/matchingEngine.ts`

### 2.2 撮合逻辑

- [ ] 撮合价格是否遵循价格优先、时间优先原则
- [ ] 是否正确处理自成交（self-trade）
- [ ] 部分成交是否正确计算剩余量
- [ ] 是否防止恶意订单簿操纵
- [ ] 撮合结果是否正确记录

### 2.3 风险检查

- [ ] 是否检查用户余额是否充足
- [ ] 是否实现了市场风险敞口限制
- [ ] 是否检查单日交易限额
- [ ] 是否防止套利攻击

---

## 三、结算安全

### 3.1 批量结算

- [ ] 结算批次大小是否在合约限制内
- [ ] 是否正确处理结算失败的情况
- [ ] 重试机制是否安全（是否可能重复结算）
- [ ] Gas 价格设置是否合理
- [ ] 是否正确处理链上确认

**关键文件：**
- `services/relayer/src/settlement/batchSettler.ts`

### 3.2 交易签名

- [ ] Operator 私钥是否安全存储
- [ ] 是否使用了硬件安全模块（HSM）或密钥管理服务
- [ ] 批量签名是否正确实现
- [ ] 私钥访问是否有审计日志

### 3.3 链上交互

- [ ] 是否正确处理链上错误
- [ ] 是否实现了交易超时机制
- [ ] 是否正确验证链上事件
- [ ] 是否防止了重放攻击

---

## 四、账户抽象（AA）安全

### 4.1 UserOp 验证

- [ ] 是否验证 UserOp 的 sender 地址
- [ ] 是否验证 nonce 正确性
- [ ] 是否验证 paymaster 配置
- [ ] 是否正确处理签名聚合

**关键文件：**
- `services/relayer/src/routes/aaRoutes.ts`

### 4.2 Paymaster 安全

- [ ] Paymaster 签名验证是否正确
- [ ] 是否验证 UserOp 的 gas 限制
- [ ] 是否实现了 Paymaster 速率限制
- [ ] 是否正确处理 Paymaster 资金不足情况

### 4.3 委托管理

- [ ] 委托更新是否有正确授权
- [ ] 是否防止了委托劫持攻击
- [ ] 委托过期机制是否正确实现

---

## 五、数据安全

### 5.1 数据库安全

- [ ] 是否使用参数化查询防止 SQL 注入
- [ ] 数据库连接是否加密
- [ ] 是否实现了数据库访问审计
- [ ] 敏感数据是否加密存储
- [ ] 是否正确处理数据库连接失败

**关键文件：**
- `services/relayer/src/database/connectionPool.ts`

### 5.2 Redis 缓存安全

- [ ] Redis 连接是否使用 TLS
- [ ] 是否实现了适当的缓存过期策略
- [ ] 敏感数据是否缓存在 Redis 中
- [ ] 缓存击穿和穿透防护

### 5.3 输入验证

- [ ] 所有外部输入是否经过验证
- [ ] 是否使用了 Zod 等库进行模式验证
- [ ] 文件上传是否有大小限制
- [ ] 是否防止了 XSS 攻击

---

## 六、基础设施安全

### 6.1 服务间通信

- [ ] 集群节点间通信是否加密
- [ ] 是否使用了安全的 Pub/Sub 实现
- [ ] 服务发现机制是否安全
- [ ] 是否实现了服务间认证

**关键文件：**
- `services/relayer/src/cluster/pubsub.ts`

### 6.2 日志与监控

- [ ] 是否记录了所有敏感操作
- [ ] 日志中是否包含敏感信息（密码、密钥）
- [ ] 是否实现了日志完整性保护
- [ ] 异常行为是否触发告警

### 6.3 配置管理

- [ ] 敏感配置是否存储在环境变量或密钥管理服务中
- [ ] 是否验证了所有必需的环境变量
- [ ] 开发环境配置是否与生产环境隔离
- [ ] 是否实现了配置热更新的安全机制

**关键文件：**
- `services/relayer/src/env.ts`

---

## 七、网络安全

### 7.1 TLS 配置

- [ ] 是否使用 TLS 1.2 或更高版本
- [ ] 证书是否有效且未过期
- [ ] 是否启用了 HSTS
- [ ] 是否正确配置了 TLS 密码套件

### 7.2 DDoS 防护

- [ ] 是否实现了速率限制
- [ ] 是否使用了 CDN 或 DDoS 防护服务
- [ ] 是否实现了连接超时机制
- [ ] 是否限制了并发连接数

### 7.3 CORS 配置

- [ ] CORS 配置是否限制允许的源
- [ ] 是否允许了不安全的 HTTP 方法
- [ ] 是否允许了凭证请求（credentials）

---

## 八、智能合约交互安全

### 8.1 合约调用

- [ ] 是否验证了合约地址
- [ ] 是否正确处理合约调用失败
- [ ] 是否实现了重试机制
- [ ] 是否防止了预言机攻击

### 8.2 事件监听

- [ ] 是否正确验证链上事件
- [ ] 是否处理了分叉情况
- [ ] 是否正确处理事件重组（reorg）

---

## 九、审计工具与命令

### 9.1 静态分析

```bash
# 运行 TypeScript 类型检查
npm run typecheck -w services/relayer

# 运行 ESLint
npm run lint -w services/relayer
```

### 9.2 依赖安全扫描

```bash
# 检查已知漏洞
npm audit -w services/relayer

# 使用 Snyk 检查
npx snyk test
```

### 9.3 Chaos Testing

```bash
# 运行混沌测试
npm test -w services/relayer -- --run
```

---

## 十、审计报告模板

### 10.1 发现的问题分类

| 严重性 | 描述 | 影响 | 建议修复 |
|--------|------|------|----------|
| 严重 | 可直接导致资金损失 | 高 | 立即修复 |
| 高 | 可导致重大安全风险 | 高 | 1周内修复 |
| 中 | 可能导致安全问题 | 中 | 2周内修复 |
| 低 | 最佳实践建议 | 低 | 1个月内修复 |

### 10.2 审计结论

- [ ] 通过所有安全检查
- [ ] 存在需要修复的问题
- [ ] 需要进一步评估

---

## 十一、外部审计建议

### 11.1 推荐审计机构

- Trail of Bits
- OpenZeppelin
- Consensys Diligence
- Certik

### 11.2 审计范围建议

建议在以下情况下进行外部审计：
1. 主网部署前
2. 重大功能更新后
3. 季度安全检查
4. 安全事件发生后

---

## 十二、合规检查

### 12.1 数据保护

- [ ] 是否符合 GDPR 要求
- [ ] 用户数据删除机制
- [ ] 数据保留策略

### 12.2 金融合规

- [ ] KYC/AML 检查
- [ ] 交易监控
- [ ] 大额交易报告

---

## 更新日志

| 日期 | 版本 | 修改内容 | 修改人 |
|------|------|----------|--------|
| 2024-01-24 | 1.0 | 初始版本 | Foresight Team |
