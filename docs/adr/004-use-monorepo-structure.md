# ADR-004：采用 Monorepo 管理多项目

## 状态

已接受

## 日期

2024-01-01

## 背景

Foresight 项目包含多个相互关联但功能独立的子项目：
- 前端应用（Next.js）
- Relayer 服务（Node.js/TypeScript）
- 智能合约（Solidity）
- 共享类型和工具库

需要一种方式来组织这些代码库，确保版本一致性和代码复用。

主要考虑的选择包括：
- 多仓库（Multi-repo）
- 单仓库（Monorepo）
- 混合方案

## 决策

采用 Monorepo 结构，使用 npm workspaces 管理。

## 目录结构

```
Foresight-beta/
├── apps/
│   ├── web/                 # Next.js 前端应用
│   └── ...                 # 其他应用
├── packages/
│   ├── shared/             # 共享类型和工具
│   ├── contracts/          # 合约相关包
│   └── ...                 # 其他包
├── services/
│   └── relayer/            # Relayer 服务
├── infra/                  # 基础设施配置
├── scripts/                # 部署脚本
└── docs/                   # 文档
```

## 原因

1. **代码共享**：方便共享类型定义、工具函数
2. **版本管理**：统一管理依赖版本，避免版本冲突
3. **原子性更改**：相关更改可以在一次提交中完成
4. **简化协作**：团队成员可以在同一个仓库中工作
5. **CI/CD**：统一的构建和测试流程

## 替代方案

- **多仓库**：每个项目独立，便于权限管理，但版本同步困难
- **Git Submodules**：代码耦合度低，但操作复杂
- **NPM 私有仓库**：发布流程复杂

## 后果

### 正面

- 统一的开发体验
- 便于代码复用
- 简化依赖管理
- 更好的代码可见性

### 负面

- 仓库体积大
- CI/CD 配置复杂
- 权限管理相对粗粒度
- 需要团队遵循规范
