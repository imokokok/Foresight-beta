# ADR-003：采用链下撮合 + 链上结算架构

## 状态

已接受

## 日期

2024-01-01

## 背景

预测市场需要处理大量高频订单，同时需要确保交易的安全性和最终性。纯链上撮合 gas 成本高、性能差；纯链下撮合缺乏信任基础。

主要考虑的选择包括：
- 完全链上（Uniswap V3 模式）
- 链下撮合 + 链上结算（Polymarket 模式）
- 中心化订单簿

## 决策

采用链下撮合 + 链上结算架构，参考 Polymarket 的 Operator 模式。

## 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                      前端 (Next.js)                          │
├─────────────────────────────────────────────────────────────┤
│                      Relayer 服务                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 订单验证    │→ │ 订单撮合    │→ │ 批量结算 (Operator) │  │
│  │ Validation  │  │ Matching    │  │ Settlement          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 风险检查    │  │ 订单簿管理  │  │ 链上事件监听        │  │
│  │ Risk Check  │  │ Order Book  │  │ Event Listener      │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    智能合约 (Solidity)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 市场合约    │  │ 验证合约    │  │ 结算合约            │  │
│  │ Market      │  │ Verification│  │ Settlement          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 原因

1. **性能**：链下撮合可以在毫秒级完成，支持高频交易
2. **成本**：批量链上结算显著降低 gas 成本
3. **用户体验**：即时确认和更好的价格发现
4. **安全性**：链上验证确保所有交易可验证
5. **去中心化**：通过 Operator 机制保持一定程度的去中心化

## 替代方案

- **完全链上**：低成本但用户体验差，gas 成本高
- **中心化**：性能最好但缺乏信任

## 后果

### 正面

- 高性能订单处理
- 低 gas 成本
- 良好的用户体验
- 可验证的交易

### 负面

- 架构复杂度高
- 需要信任 Operator
- 链下状态同步挑战
- 监控和运维成本
