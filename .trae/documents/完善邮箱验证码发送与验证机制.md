## 现状核查
- 验证码：6 位数字，当前有效期 5 分钟（/api/email-otp/request）。
- 发送方式：占位日志输出，无 SMTP 或第三方邮件服务集成。
- 队列：未发现任何邮件队列系统。
- 格式校验：使用 /.+@.+\..+/ 的基础校验，前后端均有。
- 日志：console.log 记录发送与验证；无持久化日志表；无法直接导出最近 10 条业务日志。
- 反垃圾：仓库中无 SPF/DKIM/DMARC 配置记录（属域名 DNS 与发信服务侧配置）。

## 拟实施改动
### 1) 验证码生成与有效期
- 将有效期从 5 分钟调整至 15 分钟（900_000 毫秒）。
- 保持 6 位随机数字生成逻辑：
```
function genCode() { return String(Math.floor(100000 + Math.random() * 900000)) }
// rec.expiresAt = now + 15 * 60_000
```

### 2) 集成 SMTP 邮件服务
- 使用 Nodemailer 集成企业 SMTP。
- 新增环境变量：`SMTP_HOST`, `SMTP_PORT`, `SMTP_SECURE`(true/false), `SMTP_USER`, `SMTP_PASS`, `SMTP_FROM`。
- 发送策略：HTML+纯文本双版本，含品牌抬头与验证码说明；异常时捕获并返回明确错误。
- TLS：启用 `secure: true`（465）或 `starttls`（587），按服务商要求配置。

### 3) 邮件队列处理
- 初版：直接同步发送；可选升级：接入 BullMQ + Redis 建队列并异步处理重试（3 次指数退避）。
- 队列消息字段：`email,address,code,expiresAt,ip,createdAt`。

### 4) 邮箱格式与输入校验
- 保留现有前后端基础正则；在前端 WalletModal 已实时校验与禁用按钮；后端接口继续校验格式与会话地址一致。

### 5) 发送日志持久化
- 新增表 `email_logs(email, address, status, message_id, error, sent_at, ip)`。
- 在发送成功/失败后写入日志；新增 `GET /api/email-otp/logs?limit=10` 用于查询最近 10 条。

### 6) 反垃圾邮件配置
- 指南与校验：
  - SPF：`v=spf1 include:spf.yourprovider ~all`
  - DKIM：生成选择器与私钥；DNS TXT 绑定公钥；应用于发件域。
  - DMARC：`v=DMARC1; p=quarantine; rua=mailto:dmarc@yourdomain`
- 验证渠道：使用 `mail-tester.com`/`Google Postmaster` 检查评分与拦截概率。

## 输出与交付
- 验证码生成代码片段：如上所示（改为 15 分钟）。
- 邮件服务配置参数截图：集成完成后，提供 `.env.local` 红acted 版本与服务商面板截图。
- 最近 10 条邮件发送日志记录：完成日志表与接口后，从 `/api/email-otp/logs` 导出展示。
- 接收端垃圾邮件箱检查：在测试收件邮箱（如 Gmail/Outlook）进行实际投递后，截取垃圾箱/收件箱状态说明。

## 安全与速率限制
- 维持每小时最多 3 次发送、失败 3 次锁定 1 小时。
- 所有接口继续校验 `fs_session` 中的钱包地址；可选增强：在请求体附带 SIWE 署名与消息，服务端复验。

## 确认后执行顺序
1. 修改有效期为 15 分钟并完善错误文案。
2. 引入 Nodemailer 并配置 SMTP 环境变量；添加发送函数。
3. 可选接入 BullMQ 队列；否则保持同步发送。
4. 新增 `email_logs` 表与日志写入；添加查询最近日志接口。
5. 提供配置截图与日志样例；完成垃圾邮箱检查并记录结果。
6. 提交代码并验证端到端流程（倒计时、重发、限流、锁定、审计）。