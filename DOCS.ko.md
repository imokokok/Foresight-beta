# ğŸ“š Foresight ê°œë°œì ë¬¸ì„œ v3.0

> ìŠ¤ë§ˆíŠ¸ ê³„ì•½, í”„ë¡ íŠ¸ì—”ë“œ ì•„í‚¤í…ì²˜, Relayer ì„œë¹„ìŠ¤, API ì„¤ê³„, ë°ì´í„°ë² ì´ìŠ¤, ë°°í¬, ë³´ì•ˆ, í…ŒìŠ¤íŠ¸ ë° ë¬¸ì œ í•´ê²°ì„ ë‹¤ë£¨ëŠ” ì™„ì „í•œ ê¸°ìˆ  ì°¸ì¡° ë§¤ë‰´ì–¼.

---

## ğŸ“‘ ëª©ì°¨

1. [ì•„í‚¤í…ì²˜ ê°œìš”](#1-ì•„í‚¤í…ì²˜-ê°œìš”)
2. [ìŠ¤ë§ˆíŠ¸ ê³„ì•½](#2-ìŠ¤ë§ˆíŠ¸-ê³„ì•½)
3. [í”„ë¡ íŠ¸ì—”ë“œ ì•„í‚¤í…ì²˜](#3-í”„ë¡ íŠ¸ì—”ë“œ-ì•„í‚¤í…ì²˜)
4. [Relayer ì„œë¹„ìŠ¤](#4-relayer-ì„œë¹„ìŠ¤)
5. [API ì°¸ì¡°](#5-api-ì°¸ì¡°)
6. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#6-ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
7. [ë°°í¬ ê°€ì´ë“œ](#7-ë°°í¬-ê°€ì´ë“œ)
8. [ë³´ì•ˆ ê·œë²”](#8-ë³´ì•ˆ-ê·œë²”)
9. [í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ](#9-í…ŒìŠ¤íŠ¸-ê°€ì´ë“œ)
10. [ë¬¸ì œ í•´ê²°](#10-ë¬¸ì œ-í•´ê²°)

---

## 1. ì•„í‚¤í…ì²˜ ê°œìš”

### 1.1 ì‹œìŠ¤í…œ ì†Œê°œ

ForesightëŠ” **ì˜¤í”„ì²´ì¸ ë§¤ì¹­ + ì˜¨ì²´ì¸ ì •ì‚°** í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜ ê¸°ë°˜ì˜ íƒˆì¤‘ì•™í™” ì˜ˆì¸¡ ì‹œì¥ í”Œë«í¼ì…ë‹ˆë‹¤. ì´ ì„¤ê³„ëŠ” ì¤‘ì•™í™” ê±°ë˜ì†Œì˜ ì¥ì (ë¹ ë¥¸ ì†ë„, ë‚®ì€ ë¹„ìš©, ë¶€ë“œëŸ¬ìš´ ì‚¬ìš©ì ê²½í—˜)ê³¼ ë¸”ë¡ì²´ì¸ì˜ ì¥ì (ë¶ˆë³€ì„±, íˆ¬ëª…ì„±, íƒˆì¤‘ì•™í™”)ì„ ê²°í•©í•©ë‹ˆë‹¤. ì‹œìŠ¤í…œì€Polygon ë„¤íŠ¸ì›Œí¬ë¥¼ í™œìš©í•˜ì—¬ ë‚®ì€ íŠ¸ëœì­ì…˜ ë¹„ìš©ê³¼ ë¹ ë¥¸ ìµœì¢…ì„±ì„ ì œê³µí•˜ë©°, UMA í”„ë¡œí† ì½œì„ í†µí•©í•˜ì—¬ ì‹œì¥ì˜ ê²°ê³¼ë¥¼ íƒˆì¤‘ì•™í™”ë˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°©ì‹ìœ¼ë¡œ í•´ê²°í•©ë‹ˆë‹¤.

ê¸°ìˆ  ì•„í‚¤í…ì²˜ëŠ” ì„¸ ê°œì˜ ì£¼ìš” ìƒí˜¸ ì—°ê²° ë ˆì´ì–´ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. ì¸í„°ë™ì…˜ ë ˆì´ì–´ëŠ” Next.js ì›¹ ì•±, ë„¤ì´í‹°ë¸Œ ëª¨ë°”ì¼ ì•±, ì„œë“œíŒŒí‹° í†µí•©ì„ ìœ„í•œ REST APIë¥¼ í†µí•´ ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ëŠ” ê³ ì„±ëŠ¥ Relayer ë§¤ì¹­ ì—”ì§„, ì˜¤ë”ë¶ ê´€ë¦¬, ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì§‘, ì§€ì†ì  ì €ì¥ì„ ìœ„í•œ Supabase ë°ì´í„°ë² ì´ìŠ¤ê°€ í¬í•¨ë©ë‹ˆë‹¤. ë§ˆì§€ë§‰ìœ¼ë¡œ ë¸”ë¡ì²´ì¸ ë ˆì´ì–´ì—ëŠ” Polygonì— ë°°í¬ëœ ìŠ¤ë§ˆíŠ¸ ê³„ì•½ì´ ìˆìœ¼ë©°, ì—¬ê¸°ì—ëŠ” ì‹œì¥ íŒ©í† ë¦¬, ê²°ê³¼ìš© ERC-1155 í† í°, ê²°ê³¼ ê²€ì¦ì„ ìœ„í•œ UMA ì˜¤ë¼í´ ì–´ëŒ‘í„°ê°€ í¬í•¨ë©ë‹ˆë‹¤.

ì´ëŸ¬í•œ ì±…ì„ ë¶„ë¦¬ëŠ” íš¨ìœ¨ì ì¸ ìˆ˜í‰ì  í™•ì¥ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ê³ ë¹ˆë„ ì‘ì—…(ì˜¤ë” ë§¤ì¹­, ì˜¤ë”ë¶ ì—…ë°ì´íŠ¸)ì€ Relayer ì„œë¹„ìŠ¤ì— ì˜í•´ ì˜¤í”„ì²´ì¸ì—ì„œ ìˆ˜í–‰ë˜ëŠ” ë°˜ë©´, ì¬ì •ì  ì •ì‚°, ì‹œì¥ ìƒì„±, ê²°ê³¼ í•´ê²°ê³¼ ê°™ì€ ì¤‘ìš”í•œ ì‘ì—…ì€ ë³´ì•ˆê³¼ íƒˆì¤‘ì•™í™”ë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ ë¸”ë¡ì²´ì¸ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ ë‘ ì„¸ê³„ ì‚¬ì´ì˜ ë‹¤ë¦¬ëŠ” EIP-712 ê¸°ë°˜ ì•”í˜¸í™” ê²€ì¦ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ë³´ì¥ë˜ë©°, ì‚¬ìš©ìëŠ” ì„œëª…ëœ ì˜¤ë”ë¥¼ ì œì¶œí•  ìˆ˜ ìˆìœ¼ë©° ì´ ì˜¤ë”ëŠ” Relayerì— ì˜í•´ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°©ì‹ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

### 1.2 ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ê³„ì¸µ                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Web App    â”‚  â”‚  Mobile App â”‚  â”‚  API Client â”‚  â”‚  Bot/SDK    â”‚   â”‚
â”‚  â”‚  (Next.js)  â”‚  â”‚  (React     â”‚  â”‚  (REST)     â”‚  â”‚  (Python/   â”‚   â”‚
â”‚  â”‚  15.5.4     â”‚  â”‚   Native)   â”‚  â”‚  HTTP/WS    â”‚  â”‚   JS)       â”‚   â”‚
â”‚  â”‚  React 19   â”‚  â”‚  (Future)   â”‚  â”‚             â”‚  â”‚             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ì„œë¹„ìŠ¤ ê³„ì¸µ                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                      Relayer Service                                â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚â”‚
â”‚  â”‚  â”‚ Order Book    â”‚ â”‚ Matching      â”‚ â”‚ Event         â”‚             â”‚â”‚
â”‚  â”‚  â”‚ Management    â”‚ â”‚ Engine        â”‚ â”‚ Ingestion     â”‚             â”‚â”‚
â”‚  â”‚  â”‚ (Redis)       â”‚ â”‚ (TypeScript)  â”‚ â”‚ (WebSocket)   â”‚             â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚â”‚
â”‚  â”‚  â”‚ Rate Limiting â”‚ â”‚ Auth (SIWE)   â”‚ â”‚ Order Signing â”‚             â”‚â”‚
â”‚  â”‚  â”‚ (Redis)       â”‚ â”‚ Validation    â”‚ â”‚ Verification  â”‚             â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                    â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                         Supabase Cluster                            â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚â”‚
â”‚  â”‚  â”‚ Orders    â”‚ â”‚ Trades    â”‚ â”‚ Candles   â”‚ â”‚ Users     â”‚          â”‚â”‚
â”‚  â”‚  â”‚ Table     â”‚ â”‚ Table     â”‚ â”‚ Table     â”‚ â”‚ Table     â”‚          â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ ì •ì‚° í”„ë¡œí† ì½œ
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             ë¸”ë¡ì²´ì¸ ê³„ì¸µ                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                  Polygon Network (Amoy/Mainnet)                     â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚              MarketFactory (UUPS Proxy)                     â”‚   â”‚â”‚
â”‚  â”‚  â”‚  â€¢ createMarket()     â€¢ pauseMarket()     â€¢ resolveMarket() â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚        OffchainMarketBase (Template Implementation)         â”‚   â”‚â”‚
â”‚  â”‚  â”‚  â€¢ placeOrder()       â€¢ fillOrder()      â€¢ cancelOrder()   â”‚   â”‚â”‚
â”‚  â”‚  â”‚  â€¢ claimWinnings()    â€¢ withdraw()       â€¢ batchExecute()  â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚          OutcomeToken1155 (ERC-1155 Multi-Token)           â”‚   â”‚â”‚
â”‚  â”‚  â”‚  â€¢ mint()             â€¢ safeTransferFrom()  â€¢ burn()       â”‚   â”‚â”‚
â”‚  â”‚  â”‚  â€¢ setApprovalForAll()                    â€¢ balanceOf()     â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â”‚                                                                     â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚          UMAOracleAdapterV2 (Oracle Integration)            â”‚   â”‚â”‚
â”‚  â”‚  â”‚  â€¢ requestPrice()      â€¢ settleMarket()    â€¢ getSettledPriceâ”‚   â”‚â”‚
â”‚  â”‚  â”‚  â€¢ assertTruth()       â€¢ retrySettle()                      â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ì£¼ìš” ë°ì´í„° íë¦„

Foresightì˜ ë°ì´í„° íë¦„ì€ ì˜¤ë” ìƒì„±ë¶€í„° ì •ì‚°ê¹Œì§€ ì˜ ì •ì˜ëœ ê²½ë¡œë¥¼ ë”°ë¦…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ íŠ¹ì • ê²°ê³¼ì— ë² íŒ…í•˜ê¸°ë¡œ ê²°ì •í•˜ë©´, ëŒ€ìƒ ì‹œì¥ ì£¼ì†Œ, ì„ íƒí•œ ê²°ê³¼ ì¸ë±ìŠ¤, ì˜¤ë” ë°©í–¥(ë§¤ìˆ˜ ë˜ëŠ” ë§¤ë„), ìˆ˜ìš© ê°€ëŠ¥í•œ ìµœëŒ€ ê°€ê²©, ì›í•˜ëŠ” í† í° ìˆ˜ëŸ‰, ë§Œë£Œ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í¬í•¨í•œ ì˜¤ë” ê°ì²´ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤. ì´ ê°ì²´ëŠ” EIP-712 í‘œì¤€ì— ë”°ë¼ ì‚¬ìš©ìì˜ ê°œì¸ í‚¤ë¡œ ì•”í˜¸í™” ì„œëª…ë˜ì–´, ì¦‰ê°ì ì¸ ë¸”ë¡ì²´ì¸ íŠ¸ëœì­ì…˜ ì—†ì´ ì‚¬ìš©ìì˜ ì˜ë„ë¥¼ ê²€ì¦ ê°€ëŠ¥í•œ ì¦ëª…ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.

ì„œëª…ëœ ì˜¤ë”ëŠ” WebSocket ì—°ê²° ë˜ëŠ” HTTP REST ìš”ì²­ì„ í†µí•´ Relayer ì„œë¹„ìŠ¤ë¡œ ì „ì†¡ë©ë‹ˆë‹¤. RelayerëŠ” ë¨¼ì € EIP-712 ì„œëª…ì˜ ìœ íš¨ì„±ì„ ê²€ì¦í•˜ê³  MarketFactory ê³„ì•½ì„œë¥¼ í™•ì¸ ë„ë©”ì¸ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì˜¤ë”ê°€ ìˆ˜ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©° ì„ ì–¸ëœ ì£¼ì†Œì˜ ì •ë‹¹í•œ ì†Œìœ ìì—ì„œ ë¹„ë¡¯ë˜ì—ˆìŒì„ í™•ì¸í•©ë‹ˆë‹¤. ì„œëª…ì´ ìœ íš¨í•˜ë©´ ì˜¤ë”ê°€ Redis ë©”ëª¨ë¦¬ ë‚´ ì˜¤ë”ë¶ì— í†µí•©ë˜ì–´ ë§¤ì¹­ íì— ì¶”ê°€ë©ë‹ˆë‹¤. ë§¤ì¹­ ì—”ì§„ì€ ì§€ì†ì ìœ¼ë¡œ ìƒˆ ì˜¤ë”ë¥¼ ê²€í† í•˜ê³  ê¸°ì¡´ ì˜¤ë”ë¶ì˜ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² ì˜¤ë”ì™€ ëŒ€ì¡°í•˜ì—¬ ê°€ê²© ì¡°ê±´ì´ ì¶©ì¡±ë˜ë©´ íŠ¸ëœì­ì…˜ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

ë§¤ì¹­ì´ ë°œê²¬ë˜ë©´ Relayerê°€ ë¸”ë¡ì²´ì¸ì— ì œì¶œë  ì •ì‚° íŠ¸ëœì­ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤. ì´ íŠ¸ëœì­ì…˜ì—ëŠ” ë§¤ì¹­ëœ ë‘ ì˜¤ë”, í•´ë‹¹ ì„œëª…, ê²€ì¦ëœ ê°€ê²© ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤. íŠ¸ëœì­ì…˜ì€ ì‹œìŠ¤í…œì´ ì œì–´í•˜ëŠ” ì„œë¹„ìŠ¤ ê³„ì •(EOA)ì„ í†µí•´ ì‹œì¥ ê³„ì•½ì„œì˜ fillOrder() í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹¤í–‰ë©ë‹ˆë‹¤. ê³„ì•½ì„œëŠ” ì„œëª…ì„ ë‹¤ì‹œ í™•ì¸í•˜ê³ , ë‹¹ì‚¬ì ê°„ ERC-1155 í† í°ì„ ì´ì „í•˜ë©°, ì‹œì¥ì˜ ë‚´ë¶€ ì”ì•¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. ì´ ì¤‘ë³µ ê²€ì¦ í”„ë¡œì„¸ìŠ¤ëŠ” Relayerê°€ ì†ìƒë˜ë”ë¼ë„ ì–´ëŠ ë‹¹ì‚¬ìë„ ì‚¬ê¸°ì¹  ìˆ˜ ì—†ìŒì„ ë³´ì¥í•©ë‹ˆë‹¤.

ì˜¨ì²´ì¸ ì‹¤í–‰ í›„, ê³„ì•½ì„œì—ì„œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ëŠ” Relayerì˜ ì´ë²¤íŠ¸ ìˆ˜ì§‘ ì‹œìŠ¤í…œì— ì˜í•´ í¬ì°©ë˜ì–´, ì‹œì¥ í†µê³„ ì—…ë°ì´íŠ¸, ì°¨íŠ¸ìš© OHLCV ë°ì´í„° ìƒì„±, ê±°ë˜ ê¸°ë¡ì„ Supabaseì— ì €ì¥í•˜ì—¬ ì˜ì†ì„±ì„ í™•ë³´í•©ë‹ˆë‹¤. ì‚¬ìš©ìëŠ” ì›¹ ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ìì‹ ì˜ í¬ì§€ì…˜, ì ì¬ì  ìˆ˜ìµ, ê±°ë˜ ë‚´ì—­ì„ ì¡°íšŒí•  ìˆ˜ ìˆìœ¼ë©°, í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì •ëœ WebSocket ì—°ê²°ì„ í†µí•´ ëª¨ë“  ë°ì´í„°ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°±ì‹ ë©ë‹ˆë‹¤.

### 1.4 í•µì‹¬ ê¸°ìˆ  íŠ¹ì§•

Foresight ì‹œìŠ¤í…œì€ ì „í†µì ì¸ ì˜ˆì¸¡ ì‹œì¥ êµ¬í˜„ê³¼ êµ¬ë³„ë˜ëŠ” ì—¬ëŸ¬ ê³ ê¸‰ ê¸°ìˆ ì  íŠ¹ì§•ì„ í†µí•©í•©ë‹ˆë‹¤. ë§¤ì¹­ ë©”ì»¤ë‹ˆì¦˜ì€ ê°€ê²©-ì‹œê°„ ìš°ì„ ìˆœìœ„(price-time priority) ì˜¤ë”ë¶ ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬, ìµœìƒì˜ ê°€ê²©ì˜ ì˜¤ë”ê°€ ë¨¼ì € ì‹¤í–‰ë˜ê³  ë™ì¼í•œ ê°€ê²©ì˜ ì˜¤ë”ëŠ” ë„ì°© ìˆœì„œì— ë”°ë¼ ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì€ ê³µì •í•˜ê³  íš¨ìœ¨ì ì¸ ê°€ê²© ë°œê²¬ì„ ë³´ì¥í•˜ì—¬, ì‹œì¥ ì°¸ì—¬ìë“¤ì´ ë‹¤ì–‘í•œ ê²°ê³¼ì˜ ì¸ì‹ í™•ë¥ ì„ ì„¸ë°€í•˜ê²Œ í‘œí˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì˜¤ë” ê´€ë¦¬ëŠ” ê° ì˜¤ë”ë¥¼ íŠ¹ì • ë„ë©”ì¸(ê²€ì¦ ê³„ì•½ì„œ ì£¼ì†Œ, ì²´ì¸ ID, ê³„ì•½ì„œ ë²„ì „)ì— ë°”ì¸ë”©í•˜ëŠ” ì •êµí•œ EIP-712 ì„œëª… ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ ë°”ì¸ë”©ì€ ë‹¤ë¥¸ ì‹œì¥ì´ë‚˜ ë‹¤ë¥¸ ì²´ì¸ ê°„ì˜ ë¦¬ ë°©ì§€í•˜ë©°, ì‚¬ìš©ìê°€ ì§€ì •ëœ ì‹œì¥í”Œë ˆì´ ê³µê²©ì„ê³¼ ì •í™•íˆ ëª…ì‹œëœ ì¡°ê±´ì—ì„œë§Œ ì‹¤í–‰ë  ìˆ˜ ìˆìŒì„ ì•Œê³  ì‹ ë¢°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜¤ë”ì—ëŠ” ë˜í•œ ìµœëŒ€ ìŠ¬ë¦¬í”¼ì§€(í•œë„ ê°€ê²©) íŒŒë¼ë¯¸í„°ê°€ í¬í•¨ë˜ì–´ ë³€ë™ì„±ì´ ë†’ì€ ê²½ìš° ë¶ˆë¦¬í•œ ê°€ê²©ìœ¼ë¡œ ì‹¤í–‰ìœ¼ë¡œë¶€í„° ì‚¬ìš©ìë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤.

ì‹œìŠ¤í…œì€ ìµœì†Œ ì§€ì—° ë° ìŠ¬ë¦¬í”¼ì§€ í—ˆìš© ë©”ì»¤ë‹ˆì¦˜ì„ í†µí•´ í”„ë¡ íŠ¸ëŸ¬ë‹ì— ëŒ€í•œ ë³´í˜¸ë¥¼ í†µí•©í•©ë‹ˆë‹¤. ì˜¤ë”ëŠ” í•œë„ ê°€ê²© ë˜ëŠ” ê·¸ ì´ìƒì—ì„œ ì‹¤í–‰ë˜ì–´, ì‚¬ìš©ìê°€ ë™ì˜ì„ ìµœì†Œí•œ ì–»í•œ ê°€ê²©ì„ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. RelayerëŠ” ìŠ¤í‘¸í•‘ ì˜¤ë”ë‚˜ ì„¸íƒ ê±°ë˜ íŒ¨í„´ê³¼ ê°™ì€ ì‹œì¥ ì¡°ì‘ ì‹œë„ë¥¼ íƒì§€í•˜ê³  ê±°ë¶€í•˜ëŠ” ì•ˆí‹°ê²Œì´ë° í†µì œë„ êµ¬í˜„í•©ë‹ˆë‹¤.

---

## 2. ìŠ¤ë§ˆíŠ¸ ê³„ì•½

### 2.1 ê³„ì•½ ì•„í‚¤í…ì²˜

Foresightì˜ ìŠ¤ë§ˆíŠ¸ ê³„ì•½ ì•„í‚¤í…ì²˜ëŠ” íŒ©í† ë¦¬-í…œí”Œë¦¿ íŒ¨í„´ì— ë”°ë¼ êµ¬ì¶•ë˜ì–´, ìƒˆë¡œìš´ ìœ í˜•ì˜ ì‹œì¥ì„ í™•ì¥ ê°€ëŠ¥í•˜ê²Œ ìƒì„±í•˜ë©´ì„œë„ ê¸°ë³¸ ë¡œì§ì„ ê³µìœ í•©ë‹ˆë‹¤. MarketFactory ê³„ì•½ì„œëŠ” ëª¨ë“  ì‹œì¥ì˜ ì¤‘ì•™ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì´ì ê´€ë¦¬ ì‘ì—…ì˜ ì§„ì…ì  ì—­í• ì„ í•©ë‹ˆë‹¤. ê°œë³„ ì‹œì¥ì€ OffchainMarketBase í…œí”Œë¦¿ì˜ í´ë¡  ì¸ìŠ¤í„´ìŠ¤ë¡œ ë°°í¬ë˜ë©°, ERC-1167 ë¯¸ë‹ˆmal í”„ë¡ì‹œ ë©”ì»¤ë‹ˆì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ë°°í¬ ë¹„ìš©ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ë‹¨ì¼ í…œí”Œë¦¿ìœ¼ë¡œ ìˆ˜ì‹­ ê°œì˜ ì‹œì¥ì„ ìƒì„±í•  ìˆ˜ ìˆìœ¼ë©°, ê° ì¸ìŠ¤í„´ìŠ¤ëŠ” ê³ ìœ í•œ ë§¤ê°œë³€ìˆ˜(ì§ˆë¬¸, ê°€ëŠ¥í•œ ê²°ê³¼, í•´ê²° ë‚ ì§œ, ê´€ë ¨ ì˜¤ë¼í´)ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.

```
contracts/
â”œâ”€â”€ MarketFactory.sol                    # ì£¼ìš” íŒ©í† ë¦¬ (UUPS ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥)
â”‚   â”œâ”€â”€ RÃ´les: Admin, Operator, Oracle
â”‚   â”œâ”€â”€ createMarket(question, outcomes, resolutionDate, oracle)
â”‚   â”œâ”€â”€ pauseMarket(marketAddress)
â”‚   â”œâ”€â”€ resolveMarket(marketAddress, ancillaryData)
â”‚   â””â”€â”€ upgradeTo(newImplementation)
â”‚
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ OffchainMarketBase.sol          # ê¸°ë³¸ í…œí”Œë¦¿ (ì¶”ìƒ)
â”‚   â”‚   â”œâ”€â”€ initialize(admin, factory)
â”‚   â”‚   â”œâ”€â”€ placeOrder(order, signature)
â”‚   â”‚   â”œâ”€â”€ fillOrder(order, signature, fillAmount)
â”‚   â”‚   â”œâ”€â”€ cancelOrder(orderHash)
â”‚   â”‚   â”œâ”€â”€ claimWinnings()
â”‚   â”‚   â”œâ”€â”€ withdraw(tokenId, amount)
â”‚   â”‚   â””â”€â”€ batchExecute(orders, signatures, fillAmounts)
â”‚   â”‚
â”‚   â”œâ”€â”€ OffchainBinaryMarket.sol        # ì´ì§„ ì‹œì¥ (ì˜ˆ/ì•„ë‹ˆì˜¤)
â”‚   â”‚   â””â”€â”€ 2ê°€ì§€ ê°€ëŠ¥í•œ ê²°ê³¼
â”‚   â”‚
â”‚   â””â”€â”€ OffchainMultiMarket8.sol        # ë‹¤ì¤‘ ê²°ê³¼ ì‹œì¥ (ìµœëŒ€ 8ê°œ)
â”‚       â””â”€â”€ 2-8ê°€ì§€ ê°€ëŠ¥í•œ ê²°ê³¼
â”‚
â”œâ”€â”€ tokens/
â”‚   â””â”€â”€ OutcomeToken1155.sol            # ERC-1155 í† í°
â”‚       â”œâ”€â”€ initialize(name, symbol, uri)
â”‚       â”œâ”€â”€ mint(to, id, amount)
â”‚       â”œâ”€â”€ safeTransferFrom(from, to, id, amount, data)
â”‚       â”œâ”€â”€ balanceOf(account, id)
â”‚       â””â”€â”€ setApprovalForAll(operator, approved)
â”‚
â””â”€â”€ oracles/
    â””â”€â”€ UMAOracleAdapterV2.sol          # UMA ì˜¤ë¼í´ ì–´ëŒ‘í„°
        â”œâ”€â”€ requestPrice(identifier, timestamp, ancillaryData)
        â”œâ”€â”€ settleMarket(marketAddress)
        â”œâ”€â”€ assertTruth(claim, bond)
        â”œâ”€â”€ retrySettle(marketAddress)
        â””â”€â”€ getSettledPrice(marketAddress)
```

### 2.2 MarketFactory ê³„ì•½ì„œ

MarketFactory ê³„ì•½ì„œëŠ” ê³„ì•½ ì‹œìŠ¤í…œì˜ í•µì‹¬ìœ¼ë¡œ, ëª¨ë“  ì‹œì¥ì˜ ìƒì„±, ê´€ë¦¬, ì œì–´ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤. OpenZeppelinì˜ UUPS(Universal Upgradeable Proxy Standard) íŒ¨í„´ì„ êµ¬í˜„í•˜ì—¬, ìƒíƒœì™€ ë°°í¬ ì£¼ì†Œë¥¼ ë³´ì¡´í•˜ë©´ì„œ í–¥í›„ ê³„ì•½ì„œ ì—…ë°ì´íŠ¸ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ê³„ì•½ì„œëŠ” ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´(AccessControl) ì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ë©°, ì„¸ ê°€ì§€ ì£¼ìš” ì—­í• ì´ ìˆìŠµë‹ˆë‹¤. ADMIN_ROLEì€ ê³„ì•½ì„œ ì—…ë°ì´íŠ¸ì™€ ê°™ì€ ìƒìœ„ ìˆ˜ì¤€ì˜ ì‘ì—…ì—, OPERATOR_ROLEì€ ì¼ì¼ ì‹œì¥ ê´€ë¦¬(ì¼ì‹œ ì¤‘ì§€, í•´ê²°)ì—, ORACLE_ROLEì€ UMA ì‹œìŠ¤í…œê³¼ì˜ ìƒí˜¸ì‘ìš©ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

createMarket í•¨ìˆ˜ëŠ” ìœ ì—°í•œ ë§¤ê°œë³€ìˆ˜ë¡œ ìƒˆë¡œìš´ ì˜ˆì¸¡ ì‹œì¥ì„ ìƒì„±í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. question ë§¤ê°œë³€ìˆ˜ëŠ” ì°¸ì—¬ìì—ê²Œ ì œì‹œë˜ëŠ” ì§ˆë¬¸ì„ í¬í•¨í•˜ë©°, ëª¨ë“  ìœ í˜•ì˜ ë¬¸ìë¥¼ ì§€ì›í•˜ê¸° ìœ„í•´ bytesë¡œ ì¸ì½”ë”©ë©ë‹ˆë‹¤. outcomes ë°°ì—´ì€ ê°€ëŠ¥í•œ ê²°ê³¼ë¥¼ ì§€ì •í•˜ë©°, ê° ê²°ê³¼ëŠ” ì •ìˆ˜ ì¸ë±ìŠ¤(0, 1, 2 ë“±)ë¡œ ì‹ë³„ë©ë‹ˆë‹¤. resolutionDateëŠ” ì‹œì¥ì´ í•´ê²°ë  ìˆ˜ ìˆëŠ” ì´í›„ì˜ ë‚ ì§œë¥¼ ì •ì˜í•˜ê³ , resolutionRewardëŠ” ì‹œì¥ì„ í•´ê²°í•˜ëŠ” ì˜¤ë¼í´ì— ëŒ€í•œ ë³´ìƒì„ êµ¬ì„±í•©ë‹ˆë‹¤. oracle ë§¤ê°œë³€ìˆ˜ëŠ” ì‚¬ìš©í•  ì˜¤ë¼í´ ê³„ì•½ì„œë¥¼ ì§€ì •í•©ë‹ˆë‹¤(ê¸°ë³¸ê°’ UMA ë˜ëŠ” ì»¤ìŠ¤í…€).

ì‹œì¥ì´ ìƒì„±ë˜ë©´ íŒ©í† ë¦¬ëŠ” ìë™ìœ¼ë¡œ ì ì ˆí•œ í…œí”Œë¦¿(ì´ì§„ ë˜ëŠ” ë‹¤ì¤‘)ì„ ê°€ë¦¬í‚¤ëŠ” ìµœì†Œ í”„ë¡ì‹œë¥¼ ë°°í¬í•˜ê³ , ìƒˆ ê³„ì•½ì„œë¥¼ ì‹œì¥ì˜ ë§¤ê°œë³€ìˆ˜ë¡œ ì´ˆê¸°í™”í•˜ë©°, ë‚´ë¶€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ì‹œì¥ì„ ê¸°ë¡í•©ë‹ˆë‹¤. íŒ©í† ë¦¬ëŠ” ë˜í•œ ìƒì„±ëœ ëª¨ë“  ì‹œì¥ì˜ ëª©ë¡ì„ ìœ ì§€í•˜ì—¬ ì¸í„°í˜ì´ìŠ¤ ë„êµ¬ì™€ ê°ì‚¬ì„ ìœ„í•œ ì‰¬ìš´ ì—´ê±°ë¥¼ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

```solidity
// MarketFactory.sol - í•µì‹¬ ì½”ë“œ ì¶”ì¶œ

contract MarketFactory is
    UUPSUpgradeable,
    AccessControlUpgradeable,
    ReentrancyGuardUpgradeable
{
    bytes32 public constant ADMIN_ROLE = keccak256("ADMIN_ROLE");
    bytes32 public constant OPERATOR_ROLE = keccak256("OPERATOR_ROLE");
    bytes32 public constant ORACLE_ROLE = keccak256("ORACLE_ROLE");

    mapping(address => bool) public isMarket;
    address[] public allMarkets;
    address public templateBinary;
    address public templateMulti;
    address public outcomeTokenImplementation;

    struct MarketParams {
        string question;
        string[] outcomes;
        uint256 resolutionDate;
        uint256 resolutionReward;
        address oracle;
        bool useUMA;
    }

    event MarketCreated(
        address indexed marketAddress,
        address indexed creator,
        string question,
        uint256 indexed category
    );

    function createMarket(
        MarketParams memory params,
        string memory category
    ) external returns (address marketAddress) {
        require(
            params.outcomes.length >= 2 && params.outcomes.length <= 8,
            "Invalid outcome count"
        );
        require(
            params.resolutionDate > block.timestamp,
            "Invalid resolution date"
        );

        // ì ì ˆí•œ í…œí”Œë¦¿ í´ë¡ 
        if (params.outcomes.length == 2) {
            marketAddress = _cloneTemplate(templateBinary);
        } else {
            marketAddress = _cloneTemplate(templateMulti);
        }

        // ì‹œì¥ ì´ˆê¸°í™”
        IMarket(marketAddress).initialize(
            msg.sender,
            address(this),
            params.question,
            params.outcomes,
            params.resolutionDate,
            params.resolutionReward,
            params.oracle
        );

        isMarket[marketAddress] = true;
        allMarkets.push(marketAddress);

        emit MarketCreated(
            marketAddress,
            msg.sender,
            params.question,
            uint256(keccak256(abi.encodePacked(category)))
        );
    }

    function pauseMarket(address marketAddress)
        external
        onlyRole(OPERATOR_ROLE)
    {
        require(isMarket[marketAddress], "Not a market");
        IMarket(marketAddress).pause();
    }

    function resolveMarket(
        address marketAddress,
        bytes memory ancillaryData,
        uint256 assertedPrice
    ) external onlyRole(OPERATOR_ROLE) {
        require(isMarket[marketAddress], "Not a market");
        IMarket(marketAddress).resolve(
            ancillaryData,
            assertedPrice
        );
    }
}
```

### 2.3 OffchainMarketBase ê³„ì•½ì„œ

OffchainMarketBase ê³„ì•½ì„œëŠ” ëª¨ë“  ì‹œì¥ ìœ í˜•ì— ê³µí†µëœ ë¡œì§ì„ ì œê³µí•˜ê³  ì˜¤ë” ë°°ì¹˜, ì‹¤í–‰, ì·¨ì†Œì˜ í•µì‹¬ ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤. ì´ ê³„ì•½ì„œëŠ” ì˜¤í”„ì²´ì¸ ì„œëª… ê²€ì¦ íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬, ì„œëª…ì´ ì‹¤í–‰ ì „ì— Relayerì— ì˜í•´ ê²€ì¦ë˜ì–´ ì˜¨ì²´ì¸ ê°€ìŠ¤ ë¹„ìš©ì„ ì¤„ì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì‚¬ìš©ìê°€ ì§ì ‘ ì‹¤í–‰í•´ì•¼ í•˜ëŠ” ê²½ìš°ë¥¼ ìœ„í•´ ê³„ì•½ì„œëŠ” ì„œëª…ì„ ê²€ì¦í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì„ ìœ ì§€í•©ë‹ˆë‹¤.

ì˜¤ë” ì‹œìŠ¤í…œì€ ê²°ê³¼(outcome) ë° ë°©í–¥(buy/sell)ë³„ë¡œ êµ¬ì„±ëœ ë°ì´í„° êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì—¬, ë§¤ì¹­ ê¸°ì¤€ì— ë§ëŠ” ì˜¤ë”ì— ëŒ€í•œ ë¹ ë¥¸ ì ‘ê·¼ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ê° ê²°ê³¼ì—ëŠ” ë§¤ë„ ì¸¡ë©´(ìš”ì²­)ê³¼ ë§¤ìˆ˜ ì¸¡ë©´(ì…ì°°)ì˜ ê³ ìœ í•œ ì˜¤ë”ë¶ì´ ìˆìœ¼ë©°, ì˜¤ë”ëŠ” ê°€ê²©ê³¼ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ë©ë‹ˆë‹¤. ì´ ì¡°ì§í™”ë¥¼ í†µí•´ ë§¤ì¹­ ì—”ì§„ì´ ìƒˆ ì˜¤ë” ì§„ì…ì— ëŒ€í•œ ìµœìƒì˜ ìƒëŒ€ë°©ì„ ë¹ ë¥´ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

fillOrder í•¨ìˆ˜ëŠ” ì˜¤ë” ì‹¤í–‰ì˜ ì£¼ìš” ì§„ì…ì ì…ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” ì˜¤ë”ì˜ ì„œëª…ì„(EIP-712ë¥¼ ì‚¬ìš©í•˜ì—¬) ê²€ì¦í•˜ê³ , ìƒì„±ì(maker)ì—ì„œ ì·¨ì–´ì(taker)ë¡œ í•´ë‹¹ ERC-1155 í† í°ì„ ì´ì „í•˜ë©°, ì‹œì¥ì˜ ë‚´ë¶€ ì”ì•¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. ì‹œì¥ì€ ê° ê²°ê³¼ì— ëŒ€í•´ ë³„ë„ì˜ ì”ì•¡ì„ ìœ ì§€í•˜ì—¬, ì‚¬ìš©ìê°€ ë™ì‹œì— ì—¬ëŸ¬ ê²°ê³¼ì— ëŒ€í•´ ë¡± ë˜ëŠ” ìˆ í¬ì§€ì…˜ì„ ë³´ìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```solidity
// OffchainMarketBase.sol - ì£¼ìš” êµ¬ì¡° ë° í•¨ìˆ˜

abstract contract OffchainMarketBase is
    UUPSUpgradeable,
    ReentrancyGuardUpgradeable,
    EIP712Upgradeable
{
    struct Order {
        address maker;
        uint256 outcome;
        bool isBuy;
        uint128 price;          // Wei ë‹¨ìœ„ ê°€ê²© (0-1e18)
        uint128 amount;         // Wei ë‹¨ìœ„ ìˆ˜ëŸ‰
        uint64 expires;         // ë§Œë£Œ íƒ€ì„ìŠ¤íƒ¬í”„
        uint64 nonce;           // ë¦¬í”Œë ˆì´ ë°©ì§€ nonce
    }

    struct Signature {
        uint8 v;
        bytes32 r;
        bytes32 s;
    }

    // ê²°ê³¼ ë° ë°©í–¥ë³„ ì˜¤ë”ë¶
    mapping(uint256 => Order[]) internal _buyOrders;
    mapping(uint256 => Order[]) internal _sellOrders;

    // ê²°ê³¼ë³„ ì‚¬ìš©ì ì”ì•¡
    mapping(address => mapping(uint256 => int256)) public balances;

    // nonce -> ì‚¬ìš©ë¨ ë§¤í•‘
    mapping(address => mapping(uint64 => bool)) public orderNonces;

    // ì‹œì¥ ìƒíƒœ
    bool public paused;
    bool public resolved;
    uint256 public resolutionTimestamp;
    int256 public settledPrice;

    // ì´ë²¤íŠ¸
    event OrderPlaced(
        bytes32 indexed orderHash,
        address indexed maker,
        uint256 indexed outcome,
        bool isBuy,
        uint128 price,
        uint128 amount
    );

    event OrderFilled(
        bytes32 indexed orderHash,
        address indexed maker,
        address indexed taker,
        uint256 outcome,
        uint128 price,
        uint128 amount
    );

    event OrderCancelled(
        bytes32 indexed orderHash,
        address indexed maker
    );

    event MarketResolved(
        uint256 indexed outcome,
        int256 price
    );

    function placeOrder(
        Order calldata order,
        Signature calldata signature
    ) external nonReentrant returns (bytes32) {
        require(!paused, "Market paused");
        require(block.timestamp < order.expires, "Order expired");
        require(order.amount > 0, "Invalid amount");
        require(order.price > 0 && order.price <= 1e18, "Invalid price");

        // ì„œëª… ê²€ì¦ (EIP-712)
        bytes32 orderHash = _hashOrder(order);
        require(_verifySignature(orderHash, signature, order.maker), "Invalid signature");

        // nonce ê²€ì¦
        require(!orderNonces[order.maker][order.nonce], "Nonce already used");
        orderNonces[order.maker][order.nonce] = true;

        // ì˜¤ë”ë¶ì— ì¶”ê°€
        if (order.isBuy) {
            _insertOrder(_buyOrders[order.outcome], order);
        } else {
            _insertOrder(_sellOrders[order.outcome], order);
        }

        emit OrderPlaced(
            orderHash,
            order.maker,
            order.outcome,
            order.isBuy,
            order.price,
            order.amount
        );

        return orderHash;
    }

    function fillOrder(
        Order calldata order,
        Signature calldata signature,
        uint128 fillAmount
    ) external nonReentrant {
        require(!paused, "Market paused");
        require(block.timestamp < order.expires, "Order expired");

        // ì„œëª… ê²€ì¦
        bytes32 orderHash = _hashOrder(order);
        require(_verifySignature(orderHash, signature, order.maker), "Invalid signature");

        require(fillAmount <= order.amount, "Fill exceeds order");
        require(orderNonces[order.maker][order.nonce], "Nonce not used");

        // ë¹„ìš©/ì§€ë¶ˆ ê³„ì‚°
        uint256 cost = (uint256(fillAmount) * order.price) / 1e18;

        if (order.isBuy) {
            // Maker íŒë§¤, Taker êµ¬ë§¤
            balances[order.maker][order.outcome] -= int256(fillAmount);
            balances[msg.sender][order.outcome] += int256(fillAmount);

            // í† í° makerì—ì„œ takerë¡œ ì´ì „
            IERC1155(outcomeToken).safeTransferFrom(
                order.maker,
                msg.sender,
                order.outcome,
                fillAmount,
                ""
            );

            // takerì—ì„œ makerë¡œ ì§€ë¶ˆ
            if (cost > 0) {
                _transferPayment(msg.sender, order.maker, cost);
            }
        } else {
            // Maker êµ¬ë§¤, Taker íŒë§¤
            balances[order.maker][order.outcome] += int256(fillAmount);
            balances[msg.sender][order.outcome] -= int256(fillAmount);

            IERC1155(outcomeToken).safeTransferFrom(
                msg.sender,
                order.maker,
                order.outcome,
                fillAmount,
                ""
            );

            if (cost > 0) {
                _transferPayment(order.maker, msg.sender, cost);
            }
        }

        // ì˜¤ë”ì˜ ë‚¨ì€ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
        order.amount -= fillAmount;

        emit OrderFilled(
            orderHash,
            order.maker,
            msg.sender,
            order.outcome,
            order.price,
            fillAmount
        );
    }

    function claimWinnings() external nonReentrant {
        require(resolved, "Not resolved");
        require(balances[msg.sender][uint256(uint32(_settledOutcome))] > 0, "No winnings");

        int256 balance = balances[msg.sender][uint256(uint32(_settledOutcome))];
        uint256 winningAmount = uint256(balance);

        // ìŠ¹ë¦¬ í† í°ì„ ê³„ì•½ì„œë¡œ ì´ì „í•˜ì—¬ ì†Œê°
        IERC1155(outcomeToken).safeTransferFrom(
            msg.sender,
            address(this),
            uint256(uint32(_settledOutcome)),
            winningAmount,
            ""
        );

        // ì§€ë¶ˆê¸ˆ ê³„ì‚° ë° ì´ì „
        uint256 payout = (winningAmount * uint256(_settledPrice)) / 1e18;
        _transferPayment(address(this), msg.sender, payout);

        balances[msg.sender][uint256(uint32(_settledOutcome))] = 0;
    }
}
```

### 2.4 ê²°ê³¼ í† í° ERC-1155

OutcomeToken1155 ê³„ì•½ì„œëŠ” ê° ì‹œì¥ì˜ êµí™˜ ê°€ëŠ¥í•œ ê²°ê³¼ë¥¼ ë‚˜íƒ€ë‚´ê¸° ìœ„í•´ ERC-1155 í‘œì¤€ì„ êµ¬í˜„í•©ë‹ˆë‹¤. ERC-721ê³¼ ë‹¬ë¦¬ ê³ ìœ  ìì‚°ì„ ë‚˜íƒ€ë‚´ëŠ” ê²ƒê³¼ ë‹¬ë¦¬, ERC-1155ëŠ” ë°˜ Fungible(ì •ëŸ‰í™” ê°€ëŠ¥) í† í°ì„ ê´€ë¦¬í•  ìˆ˜ ìˆì–´, ì‚¬ìš©ìê°€ ê²°ê³¼ì˜ ì¼ë¶€ë¥¼ ë³´ìœ í•  ìˆ˜ ìˆëŠ” ì˜ˆì¸¡ ì‹œì¥ì— ì™„ë²½í•©ë‹ˆë‹¤. ê° ì‹œì¥ì€ ê°€ëŠ¥í•œ ê²°ê³¼ ìˆ˜ë§Œí¼ ERC-1155 í† í°ì„ ìƒì„±í•˜ë©°, ê° í† í°ì€ ê³ ìœ  ì¸ë±ìŠ¤(0, 1, 2 ë“±)ë¡œ ì‹ë³„ë©ë‹ˆë‹¤.

ê³„ì•½ì„œëŠ” ì˜¨ë””ë§¨ë“œ ë¯¼íŒ… íŒ¨í„´ì„ ì‚¬ìš©í•˜ì—¬, ì‚¬ìš©ìê°€ ë§¤ìˆ˜ ì˜¤ë”ë¥¼ ë°°ì¹˜í•  ë•Œë§Œ í† í°ì´ ìƒì„±ë©ë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì€ ì‹œì¥ ìƒì„± ì‹œ ëª¨ë“  í† í°ì„ ì‚¬ì „ì— ë¯¼íŒ…í•  í•„ìš”ì„±ì„ ì—†ì• ê³  ë°°í¬ ë¹„ìš©ì„ ì¤„ì…ë‹ˆë‹¤. ì‹œì¥ì´ í•´ê²°ë˜ë©´ ìŠ¹ë¦¬ ê²°ê³¼ì— í•´ë‹¹í•˜ëŠ” í† í°ë§Œ ê°€ì¹˜ë¥¼ ê°€ì§€ë©°, ë‹¤ë¥¸ í† í°ì€ ì†Œê°ë˜ê±°ë‚˜ ê¸°ë…í’ˆìœ¼ë¡œ ìœ ì§€ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```solidity
// OutcomeToken1155.sol

contract OutcomeToken1155 is
    ERC1155Upgradeable,
    AccessControlUpgradeable,
    UUPSUpgradeable
{
    bytes32 public constant MINTER_ROLE = keccak256("MINTER_ROLE");
    bytes32 public constant BURNER_ROLE = keccak256("BURNER_ROLE");

    string public name;
    string public symbol;

    // ì‹œì¥ -> ê²°ê³¼ ì¸ë±ìŠ¤ -> ë¯¼íŒ… ê¶Œí•œ
    mapping(address => mapping(uint256 => bool)) public marketMinters;

    function initialize(
        string memory name_,
        string memory symbol_,
        string memory uri_
    ) public initializer {
        __ERC1155_init(uri_);
        __AccessControl_init();
        __UUPSUpgradeable_init();

        name = name_;
        symbol = symbol_;

        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _grantRole(MINTER_ROLE, msg.sender);
        _grantRole(BURNER_ROLE, msg.sender);
    }

    function mint(
        address to,
        uint256 id,
        uint256 amount,
        bytes memory data
    ) external onlyRole(MINTER_ROLE) {
        _mint(to, id, amount, data);
    }

    function batchMint(
        address to,
        uint256[] memory ids,
        uint256[] memory amounts,
        bytes memory data
    ) external onlyRole(MINTER_ROLE) {
        _batchMint(to, ids, amounts, data);
    }

    function burn(
        address from,
        uint256 id,
        uint256 amount
    ) external onlyRole(BURNER_ROLE) {
        _burn(from, id, amount);
    }

    // ì‹œì¥ì€ ìì‹ ì˜ í† í°ì„ ë¯¼íŒ…í•  ìˆ˜ ìˆìŒ
    function marketMint(
        address market,
        uint256 outcomeIndex,
        uint256 amount,
        bytes memory data
    ) external {
        require(
            marketMinters[market][outcomeIndex],
            "Market not authorized"
        );
        _mint(market, outcomeIndex, amount, data);
    }

    function uri(uint256 tokenId) public view override returns (string memory) {
        return string(abi.encodePacked(_uri, "/", Strings.toString(tokenId)));
    }
}
```

### 2.5 UMA ì˜¤ë¼í´ ì–´ëŒ‘í„°

UMAOracleAdapterV2 ê³„ì•½ì„œëŠ” ì‹œì¥ ê²°ê³¼ì˜ íƒˆì¤‘ì•™í™”ë¥¼ ìœ„í•´ UMA(Universal Market Access) í”„ë¡œí† ì½œì„ í†µí•©í•©ë‹ˆë‹¤. UMAëŠ” ì§„ìˆ ì´ ë„ì „ë  ìˆ˜ ìˆëŠ” ë‚™ê´€ì  ì˜¤ë¼í´ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ì—¬, ì§„ì‹¤ ì£¼ì¥ì´ ë¶„ìŸë  ìˆ˜ ìˆëŠ” í•´ê²° ë©”ì»¤ë‹ˆì¦˜ì„ ìƒì„±í•©ë‹ˆë‹¤. UMAì˜ DATA(ê±°ë²„ë„ŒìŠ¤ í† í°) ë³´ìœ ìê°€ ìì‹ ì˜ ë‹µë³€ì„ ì œì¶œí•˜ê³  ì •í™•ì„±ì— ë² íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹µë³€ì— ëŒ€í•œ ì´ì˜ê°€ ì œê¸°ë˜ì§€ ì•Šìœ¼ë©´ ë‹µë³€ì€ ìµœì¢… ê²ƒìœ¼ë¡œ ê°„ì£¼ë˜ë©°, ì‹œì¥ì€ í™•ì¸ëœ ê²°ê³¼ë¡œ ë§ˆê°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì‹œì¥ í•´ê²°ì´ í•„ìš”í•œ ê²½ìš°, ê³„ì•½ì„œëŠ” ì‹œì¥ ì‹ë³„ìì™€ ë³´ì¡° ë°ì´í„°(ì‹œì¥ ì§ˆë¬¸ í¬í•¨)ë¥¼ í¬í•¨í•˜ì—¬ UMA ì˜¤ë¼í´ì— ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤. UMA ì˜¤ë¼í´ì€ ë‹¤ìŒì— ì§ˆë¬¸ì„ DATA ë³´ìœ ìì—ê²Œ ë…¸ì¶œí•˜ì—¬, ìì‹ ë“¤ì˜ ë‹µë³€ì„ ì œì¶œí•˜ê³  ì •í™•ì„±ì— ë² íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¶„ìŸ ê¸°ê°„ ë™ì•ˆ ë‹µë³€ì´ ë„ì „ë˜ì§€ ì•Šìœ¼ë©´, ë‹µë³€ì€ ìµœì¢… ê²ƒìœ¼ë¡œ ê°„ì£¼ë˜ë©° ì‹œì¥ì€ í™•ì¸ëœ ê²°ê³¼ë¡œ ë§ˆê°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```solidity
// UMAOracleAdapterV2.sol

contract UMAOracleAdapterV2 is
    UUPSUpgradeable,
    AccessControlUpgradeable
{
    bytes32 public constant ORACLE_ADMIN_ROLE = keccak256("ORACLE_ADMIN_ROLE");

    address public umaOptimisticOracle;
    address public umaFinder;
    address public umaCollateralToken; // ì¼ë°˜ì ìœ¼ë¡œ USDC

    bytes32 public constant DEFAULT_IDENTIFIER = bytes32("ASSERT_TRUTH");

    // ì‹œì¥ -> í•´ê²° ìƒíƒœ
    struct ResolutionStatus {
        bool requested;
        bool settled;
        bytes32 assertionId;
        uint256 settledPrice;
        uint64 requestTimestamp;
    }

    mapping(address => ResolutionStatus) public resolutionStatus;

    event PriceRequested(
        address indexed marketAddress,
        bytes32 indexed identifier,
        uint64 timestamp
    );

    event PriceSettled(
        address indexed marketAddress,
        uint256 indexed outcome,
        uint256 price
    );

    event AssertionDisputed(
        bytes32 indexed assertionId,
        address indexed disputer
    );

    function initialize(
        address umaOptimisticOracle_,
        address umaFinder_,
        address umaCollateral_
    ) public initializer {
        __AccessControl_init();
        __UUPSUpgradeable_init();

        umaOptimisticOracle = umaOptimisticOracle_;
        umaFinder = umaFinder_;
        umaCollateralToken = umaCollateral_;

        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _grantRole(ORACLE_ADMIN_ROLE, msg.sender);
    }

    function requestPrice(
        address marketAddress,
        bytes memory ancillaryData,
        uint256 proposedPrice
    ) external returns (bytes32 assertionId) {
        require(
            !resolutionStatus[marketAddress].requested,
            "Price already requested"
        );

        IUmaOptimisticOracle(umaOptimisticOracle).assertTruth(
            abi.encodePacked(
                ancillaryData,  // ì‹œì¥ì˜ ì§ˆë¬¸
                ", but for the purposes of this market, the winning outcome is represented by a price between 0 and 1e18 where 0 means outcome 0 wins and 1e18 means outcome 1 wins. What is the price?"
            ),
            msg.sender,
            proposedPrice,
            1 days,  // ìœ íš¨ ê¸°ê°„
            abi.encode(marketAddress)
        );

        resolutionStatus[marketAddress] = ResolutionStatus({
            requested: true,
            settled: false,
            assertionId: assertionId,
            settledPrice: 0,
            requestTimestamp: uint64(block.timestamp)
        });

        emit PriceRequested(
            marketAddress,
            DEFAULT_IDENTIFIER,
            uint64(block.timestamp)
        );
    }

    function settleMarket(address marketAddress) external {
        ResolutionStatus storage status = resolutionStatus[marketAddress];
        require(status.requested, "No price requested");
        require(!status.settled, "Already settled");

        // UMA ì •ì‚° í•¨ìˆ˜ í˜¸ì¶œ
        // í•´ê²°ëœ ê°€ê²© ê°€ì ¸ì˜¤ê¸°
        uint256 settledPrice = _fetchSettledPrice(status.assertionId);

        status.settled = true;
        status.settledPrice = settledPrice;

        emit PriceSettled(
            marketAddress,
            settledPrice >= 5e17 ? 1 : 0, // ì´ì§„: 0 ë˜ëŠ” 1
            settledPrice
        );
    }

    function retrySettle(address marketAddress) external {
        ResolutionStatus storage status = resolutionStatus[marketAddress];
        require(status.requested, "No price requested");
        require(!status.settled, "Already settled");

        // ê°€ê²© ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
        _fetchSettledPrice(status.assertionId);
    }

    function _fetchSettledPrice(bytes32 assertionId)
        internal
        returns (uint256 price)
    {
        // ë‹¨ìˆœí™”ëœ êµ¬í˜„ - ì‹¤ì œ ë²„ì „ì€
        // UMAì˜ store ê³„ì•½ì„œì™€ ìƒí˜¸ì‘ìš©í•˜ì—¬ ìŠ¹ì¸ëœ ê°€ê²©ì„ ê°€ì ¸ì˜´
        return 0; // í”Œë ˆì´ìŠ¤í™€ë”
    }
}
```

### 2.6 ì´ë²¤íŠ¸ ë° ì˜¤ë¥˜

ìŠ¤ë§ˆíŠ¸ ê³„ì•½ì„œëŠ” ëª¨ë“  ì¤‘ìš”í•œ ì‘ì—…ì— ëŒ€í•œ ì´ë²¤íŠ¸ë¥¼ ë°©ì¶œí•˜ì—¬, íš¨ìœ¨ì ì¸ ì¸ë±ì‹±ê³¼ ëª¨ë‹ˆí„°ë§ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ì´ë²¤íŠ¸ì—ëŠ” ì‹œì¥ ìƒì„±, ì˜¤ë” ë°°ì¹˜ ë° ì‹¤í–‰, ì·¨ì†Œ, í•´ê²°, ì¶œê¸ˆì´ í¬í•¨ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì´ë²¤íŠ¸ëŠ” Relayer ì„œë¹„ìŠ¤ì— ì˜í•´ í¬ì°©ë˜ì–´ Supabaseì— ì €ì¥ë˜ì–´ ì—­ì‚¬ ë° ë¶„ì„ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

```solidity
// ì£¼ìš” ì´ë²¤íŠ¸

// MarketFactory
event MarketCreated(
    address indexed marketAddress,
    address indexed creator,
    string question,
    uint256 category,
    uint256 creationTimestamp
);

event MarketPaused(address indexed marketAddress, address indexed operator);
event MarketResolved(address indexed marketAddress, uint256 outcome);

// OffchainMarketBase
event OrderPlaced(
    bytes32 indexed orderHash,
    address indexed maker,
    uint256 indexed outcome,
    bool isBuy,
    uint128 price,
    uint128 amount,
    uint64 expires,
    uint64 nonce
);

event OrderFilled(
    bytes32 indexed orderHash,
    address indexed maker,
    address indexed taker,
    uint256 outcome,
    uint128 price,
    uint128 amount,
    uint256 makerPayment,
    uint256 takerPayment
);

event OrderCancelled(
    bytes32 indexed orderHash,
    address indexed maker,
    string reason
);

event WinningsClaimed(
    address indexed user,
    address indexed marketAddress,
    uint256 outcome,
    uint256 amount,
    uint256 payout
);

event Withdrawal(
    address indexed user,
    address indexed token,
    uint256 amount
);

// ì»¤ìŠ¤í…€ ì˜¤ë¥˜

error InvalidSignature();
error OrderExpired();
error OrderAmountZero();
error OrderPriceInvalid();
error SlippageExceeded(uint128 expected, uint128 actual);
error MarketPausedError();
error MarketNotResolved();
error NoWinnings();
error InvalidOutcome();
error UnauthorizedCaller();
error PriceNotSettled();
error DuplicateNonce();
error InsufficientBalance();
error TransferFailed();
```

### 2.7 ë³´ì•ˆ ê³ ë ¤ ì‚¬í•­

ìŠ¤ë§ˆíŠ¸ ê³„ì•½ì„œì˜ ë³´ì•ˆì€ Foresightì—ì„œ ìµœìš°ì„  ì‚¬í•­ì´ë©°, ì‹œìŠ¤í…œì´ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” ì ì¬ì ìœ¼ë¡œ ì¤‘ìš”í•œ ê¸ˆìœµì  ê°€ì¹˜ë¥¼ ê³ ë ¤í•©ë‹ˆë‹¤. ì—¬ëŸ¬ ë³´í˜¸ ë ˆì´ì–´ê°€ ì¼ë°˜ì ì¸ ê³µê²© ë²¡í„°ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ êµ¬í˜„ë©ë‹ˆë‹¤. nonReentrant ìˆ˜ì •ìëŠ” í† í° ë˜ëŠ” ETH ì´ì „ì„ ìˆ˜í–‰í•˜ëŠ” ëª¨ë“  ì™¸ë¶€ í•¨ìˆ˜ì— ì ìš©ë˜ì–´, ì—­ì‚¬ì ìœ¼ë¡œ ìˆ˜ë§ì€ ì·¨ì•½ì ì„ ì•¼ê¸°í•œ ë¦¬ì—”íŠ¸ë€ì‹œ ê³µê²©ì„ ë°©ì§€í•©ë‹ˆë‹¤.

í”Œë˜ì‹œ ë¡  ê³µê²©ì— ëŒ€í•œ ë³´í˜¸ëŠ” ì—¬ëŸ¬ ë©”ì»¤ë‹ˆì¦˜ì„ í†µí•´ êµ¬í˜„ë©ë‹ˆë‹¤. ì‹œì¥ ìƒì„± ë° í•´ê²° ì‘ì—…ì€ ì§€ì—° ë° ë³´ì•ˆ ì¡°ê±´ìœ¼ë¡œ ë³´í˜¸ë©ë‹ˆë‹¤. ì§§ì€ ê¸°ê°„ ë™ì•ˆ ì¤‘ìš”í•œ ê°€ê²© ë³€ê²½ì€ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œì—ì„œ ê²½ê³ ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤. ë˜í•œ EIP-712 ì„œëª… ê²€ì¦ ì‹œìŠ¤í…œì€ ê³µê²©ìê°€ Relayerë¥¼ ì œì–´í•˜ë”ë¼ë„ ìœ„ì¡°ëœ ì˜¤ë”ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ë„ë¡ í•˜ë©°, ê° ì˜¤ë”ëŠ” ìê¸ˆì˜ ì •ë‹¹í•œ ì†Œìœ ìê°€ ì„œëª…í•´ì•¼ í•©ë‹ˆë‹¤.

ë¹„ìƒ ì¼ì‹œ ì¤‘ì§€ ë©”ì»¤ë‹ˆì¦˜ì€ ìš´ì˜ìê°€ ì´ìƒ ì§•í›„ë‚˜ ì·¨ì•½ì  ê°ì§€ ì‹œ ì‹œì¥ ë˜ëŠ” ì „ì²´ ì‹œìŠ¤í…œì˜ ëª¨ë“  ì‘ì—…ì„ ì¼ì‹œì ìœ¼ë¡œ ì¤‘ì§€í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ OPERATOR_ROLEìœ¼ë¡œ ì œì–´ë˜ë©°, ë¹„ìƒ ì‹œ ì‚¬ìš©ìì˜ ìê¸ˆì„ ë³´í˜¸í•˜ê¸° ìœ„í•´ ë¹ ë¥´ê²Œ í™œì„±í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¬¸ì œê°€ í•´ê²°ë˜ë©´ ADMIN_ROLEì˜ ê´€ë¦¬ìê°€ ì‹œì¥ì˜ ì ê¸ˆì„ í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## 3. í”„ë¡ íŠ¸ì—”ë“œ ì•„í‚¤í…ì²˜

### 3.1 ê¸°ìˆ  ìŠ¤íƒ

Foresightì˜ í”„ë¡ íŠ¸ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ì€ React ìƒíƒœê³„ì˜ ê°€ì¥ í˜„ëŒ€ì ì¸ ê¸°ìˆ ë¡œ êµ¬ì¶•ë˜ì–´, ì„±ëŠ¥, ë³´ì•ˆ, ê°œë°œì ê²½í—˜ ìµœì í™”ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤. Next.js 15.5.4ì™€ App RouterëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ í”„ë ˆì„ì›Œí¬ë¥¼ ì œê³µí•˜ì—¬, ì„œë²„ ì¸¡ ë Œë”ë§(SSR), ì •ì  ìƒì„±(SSG), í´ë¼ì´ì–¸íŠ¸ í•˜ì´ë“œë ˆì´ì…˜ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. React 19ëŠ” ì„±ëŠ¥ ë° ê°œë°œì ê²½í—˜ ê°œì„  ì‚¬í•­ì„ ê°€ì ¸ì˜¤ë©°, Server Componentsì™€ ê°„ì†Œí™”ëœ Server Actionsë¥¼ í¬í•¨í•©ë‹ˆë‹¤. TypeScript 5.0ì€ ì „ì²´ ì½”ë“œë² ì´ìŠ¤ì— ê±¸ì³ ì™„ì „í•œ íƒ€ì… ê²€ì‚¬ë¥¼ ì œê³µí•˜ì—¬ ëŸ°íƒ€ì„ ì˜¤ë¥˜ë¥¼ ì¤„ì´ê³  ìœ ì§€ ê´€ë¦¬ë¥¼ ìš©ì´í•˜ê²Œ í•©ë‹ˆë‹¤.

ìƒíƒœ ê´€ë¦¬ëŠ” ì„œë²„ ìƒíƒœì—ëŠ” React Query(TanStack Query v5)ë¥¼, í´ë¼ì´ì–¸íŠ¸ ìƒíƒœì—ëŠ” React Context/Zustandë¥¼ ì¡°í•©í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤. React QueryëŠ” API í˜¸ì¶œì— ëŒ€í•´ ìˆ˜ë™ ìƒíƒœ ê´€ë¦¬ ë¡œì§ì„ ì œê±°í•˜ë©´ì„œ ìºì‹±, ë¦¬í˜ì¹­, ë®¤í…Œì´ì…˜, ë°ì´í„° ì„œë²„ ë™ê¸°í™”ë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤. ZustandëŠ” ì—´ë¦° ëª¨ë‹¬, ì‚¬ìš©ì ê¸°ë³¸ ì„¤ì •, ë°ì´í„°ì™€ ê´€ë ¨ ì—†ëŠ” ë¡œë”© ìƒíƒœì™€ ê°™ì€ ë¡œì»¬ ì¸í„°í˜ì´ìŠ¤ ìƒíƒœì— ì‚¬ìš©ë©ë‹ˆë‹¤.

ìŠ¤íƒ€ì¼ë§ì€ Tailwind CSS 3.4ë¡œ ìˆ˜í–‰ë˜ì–´, íŠ¸ë¦¬ ì…°ì´í‚¹ì„ í†µí•œ ìµœì†Œ CSS ë²ˆë“¤ë¡œ ë°˜ì‘í˜• ì¸í„°í˜ì´ìŠ¤ì˜ ì‹ ì†í•œ ê°œë°œì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤. ì¬ì‚¬ìš© ê°€ëŠ¥í•œ UI ì»´í¬ë„ŒíŠ¸ëŠ” Radix UI ì›ì‹œë¡œ êµ¬ì¶•ë˜ì–´, ARIA ë ˆì´ë¸”, í‚¤ë³´ë“œ íƒìƒ‰ê³¼ ê°™ì€ ë‚´ì¥ ì ‘ê·¼ì„±ì„ ì œê³µí•˜ë©´ì„œ íŠ¹ì • ë””ìì¸ì„ ê°•ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ ë¶„ë¦¬ëœ ì ‘ê·¼ ë°©ì‹ì€ ì™„ì „í•œ ì‹œê°ì  ì‚¬ìš©ì ì •ì˜ì˜ ì´ì ì„ ì–»ìœ¼ë©´ì„œë„ ì ‘ê·¼ ê°€ëŠ¥í•œ ì›ì‹œë¥¼ í™œìš©í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

| ì¹´í…Œê³ ë¦¬      | ê¸°ìˆ             | ë²„ì „   | ì—­í•                         |
| ------------- | --------------- | ------ | --------------------------- |
| í”„ë ˆì„ì›Œí¬    | Next.js         | 15.5.4 | SSR/SSG, ë¼ìš°íŒ…, API Routes |
| UI ë¼ì´ë¸ŒëŸ¬ë¦¬ | React           | 19     | ì»´í¬ë„ŒíŠ¸, ìƒíƒœ, ì´ë²¤íŠ¸      |
| ì–¸ì–´          | TypeScript      | 5.0    | ì •ì  íƒ€ì…, IDE ì§€ì›         |
| ìŠ¤íƒ€ì¼ë§      | Tailwind CSS    | 3.4    | ìœ í‹¸ë¦¬í‹° ìš°ì„  CSS           |
| ë°ì´í„° í˜ì¹­   | React Query     | 5      | ì„œë²„ ìƒíƒœ ê´€ë¦¬              |
| Web3          | ethers.js       | 6      | ë¸”ë¡ì²´ì¸ ì—°ê²°               |
| í¼            | React Hook Form | 7      | í¼ ê´€ë¦¬, ê²€ì¦               |
| i18n          | next-intl       | 5      | êµ­ì œí™”                      |
| ì°¨íŠ¸          | Recharts        | 2      | OHLCV ì°¨íŠ¸, ê±°ë˜ëŸ‰          |
| ë‚ ì§œ/ì‹œê°„     | date-fns        | 4      | í¬ë§·íŒ…, ë‚ ì§œ ì¡°ì‘           |

### 3.2 í”„ë¡œì íŠ¸ êµ¬ì¡°

í”„ë¡ íŠ¸ì—”ë“œ í”„ë¡œì íŠ¸ êµ¬ì¡°ëŠ” Next.js App Router ê·œì¹™ì„ ë”°ë¥´ë©°, ê¸°ëŠ¥ ë° ì±…ì„ë³„ ëª…í™•í•œ ì¡°ì§í™”ë¥¼ ì œê³µí•©ë‹ˆë‹¤. app/ í´ë”ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¼ìš°íŠ¸ë¥¼ í¬í•¨í•˜ë©°, ê° í•˜ìœ„ í´ë”ëŠ” í˜ì´ì§€ ë˜ëŠ” í˜ì´ì§€ ê·¸ë£¹ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. components/ í´ë”ëŠ” ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì»´í¬ë„ŒíŠ¸ë¥¼ ë²”ì£¼(uiëŠ” ì›ì‹œ, featuresëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ì»´í¬ë„ŒíŠ¸, chartsëŠ” ì‹œê°í™”)ë³„ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤. lib/ í´ë”ëŠ” ìœ í‹¸ë¦¬í‹°, êµ¬ì„±, í•˜ìœ„ ìˆ˜ì¤€ ì¶”ìƒí™”ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.

```
apps/web/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/                    # ì¸ì¦ ë¼ìš°íŠ¸
â”‚   â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ signup/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â””â”€â”€ layout.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ (main)/                    # ì£¼ìš” ë¼ìš°íŠ¸
â”‚   â”‚   â”œâ”€â”€ page.tsx               # ëŒ€ì‹œë³´ë“œ / í™ˆ
â”‚   â”‚   â”œâ”€â”€ markets/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx           # ì‹œì¥ ëª©ë¡
â”‚   â”‚   â”‚   â”œâ”€â”€ [address]/         # ì‹œì¥ ìƒì„¸
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ trades/        # ê±°ë˜ ë‚´ì—­
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ orders/        # ì˜¤ë”ë¶
â”‚   â”‚   â”‚   â””â”€â”€ create/            # ì‹œì¥ ìƒì„±
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ portfolio/             # ì‚¬ìš©ì í¬íŠ¸í´ë¦¬ì˜¤
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ leaderboard/           # ë¦¬ë”ë³´ë“œ
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ settings/              # ì‚¬ìš©ì ì„¤ì •
â”‚   â”‚       â””â”€â”€ page.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                       # API Routes (BFF)
â”‚   â”‚   â”œâ”€â”€ siwe/                  # Web3 ì¸ì¦
â”‚   â”‚   â”œâ”€â”€ orders/                # ì˜¤ë” ë° ì„œëª…
â”‚   â”‚   â”œâ”€â”€ markets/               # ì‹œì¥ ë°ì´í„°
â”‚   â”‚   â””â”€â”€ user/                  # ì‚¬ìš©ì ë°ì´í„°
â”‚   â”‚
â”‚   â”œâ”€â”€ layout.tsx                 # ë£¨íŠ¸ ë ˆì´ì•„ì›ƒ (Providers)
â”‚   â””â”€â”€ globals.css                # ê¸€ë¡œë²Œ ìŠ¤íƒ€ì¼
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/                        # ì›ì‹œ ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”œâ”€â”€ Button.tsx
â”‚   â”‚   â”œâ”€â”€ Input.tsx
â”‚   â”‚   â”œâ”€â”€ Modal.tsx
â”‚   â”‚   â”œâ”€â”€ Card.tsx
â”‚   â”‚   â”œâ”€â”€ Table.tsx
â”‚   â”‚   â”œâ”€â”€ Tabs.tsx
â”‚   â”‚   â””â”€â”€ Dropdown.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ charts/                    # ì‹œê°í™”
â”‚   â”‚   â”œâ”€â”€ PriceChart.tsx
â”‚   â”‚   â”œâ”€â”€ VolumeChart.tsx
â”‚   â”‚   â”œâ”€â”€ CandlestickChart.tsx
â”‚   â”‚   â””â”€â”€ DepthChart.tsx
â”‚   â”‚
â”‚   â”œâ”€â”€ features/                  # ë¹„ì¦ˆë‹ˆìŠ¤ ì»´í¬ë„ŒíŠ¸
â”‚   â”‚   â”œâ”€â”€ market/
â”‚   â”‚   â”‚   â”œâ”€â”€ MarketCard.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ MarketList.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderBook.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ RecentTrades.tsx
â”‚   â”‚   â”‚   â””â”€â”€ MarketDetail.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ trading/
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderForm.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderHistory.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ PositionList.tsx
â”‚   â”‚   â”‚   â””â”€â”€ TradingPanel.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”‚   â”œâ”€â”€ UserAvatar.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ FollowButton.tsx
â”‚   â”‚   â”‚   â””â”€â”€ PortfolioSummary.tsx
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ social/
â”‚   â”‚       â”œâ”€â”€ DiscussionThread.tsx
â”‚   â”‚       â”œâ”€â”€ CommentList.tsx
â”‚   â”‚       â””â”€â”€ VoteButtons.tsx
â”‚   â”‚
â”‚   â””â”€â”€ providers/                 # ì»¨í…ìŠ¤íŠ¸ Providers
â”‚       â”œâ”€â”€ Web3Provider.tsx
â”‚       â”œâ”€â”€ QueryProvider.tsx
â”‚       â””â”€â”€ I18nProvider.tsx
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ contracts/                 # ABI ë° ì£¼ì†Œ
â”‚   â”‚   â”œâ”€â”€ marketFactory.ts
â”‚   â”‚   â”œâ”€â”€ outcomeToken.ts
â”‚   â”‚   â””â”€â”€ umaOracle.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/                     # ìœ í‹¸ë¦¬í‹°
â”‚   â”‚   â”œâ”€â”€ formatting.ts          # ìˆ«ì, ë‚ ì§œ, í†µí™” í¬ë§·
â”‚   â”‚   â”œâ”€â”€ validation.ts          # ê²€ì¦ ìŠ¤í‚¤ë§ˆ
â”‚   â”‚   â””â”€â”€ constants.ts           # ê³µìœ  ìƒìˆ˜
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                     # ì»¤ìŠ¤í…€ í›…
â”‚   â”‚   â”œâ”€â”€ useWeb3.ts
â”‚   â”‚   â”œâ”€â”€ useOrders.ts
â”‚   â”‚   â””â”€â”€ useMarketData.ts
â”‚   â”‚
â”‚   â””â”€â”€ sdk/                       # í´ë¼ì´ì–¸íŠ¸ SDK
â”‚       â””â”€â”€ foresight.ts
â”‚
â”œâ”€â”€ types/                         # TypeScript ì •ì˜
â”‚   â”œâ”€â”€ market.ts
â”‚   â”œâ”€â”€ order.ts
â”‚   â”œâ”€â”€ trade.ts
â”‚   â””â”€â”€ user.ts
â”‚
â”œâ”€â”€ messages/                      # ë²ˆì—­ íŒŒì¼
â”‚   â”œâ”€â”€ en.json
â”‚   â”œâ”€â”€ zh-CN.json
â”‚   â”œâ”€â”€ es.json
â”‚   â”œâ”€â”€ fr.json
â”‚   â””â”€â”€ ko.json
â”‚
â”œâ”€â”€ public/                        # ì •ì  ìì‚°
â”‚   â”œâ”€â”€ images/
â”‚   â””â”€â”€ locales/
â”‚
â”œâ”€â”€ next.config.js                 # Next.js êµ¬ì„±
â”œâ”€â”€ tailwind.config.ts             # Tailwind êµ¬ì„±
â”œâ”€â”€ tsconfig.json                  # TypeScript êµ¬ì„±
â””â”€â”€ package.json
```

### 3.3 Providers ë° ê¸€ë¡œë²Œ êµ¬ì„±

ì• í”Œë¦¬ì¼€ì´ì…˜ì€ React providers ì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ì—¬ ì˜ì¡´ì„±ê³¼ êµ¬ì„±ì„ ì»´í¬ë„ŒíŠ¸ íŠ¸ë¦¬ì— ì£¼ì…í•©ë‹ˆë‹¤. ë£¨íŠ¸ ë ˆì´ì•„ì›ƒì€ í•„ìš”í•œ ëª¨ë“  Providersë¥¼ ê²°í•©í•˜ê³  ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ê¸€ë¡œë²Œ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.

```typescript
// app/layout.tsx

import type { Metadata } from 'next';
import { Web3Provider } from '@/components/providers/Web3Provider';
import { QueryProvider } from '@/components/providers/QueryProvider';
import { I18nProvider } from '@/components/providers/I18nProvider';
import { Toaster } from '@/components/ui/Toaster';
import './globals.css';

export const metadata: Metadata = {
  title: 'Foresight - Prediction Markets',
  description: 'Decentralized prediction market platform',
  icons: '/favicon.ico',
};

export default function RootLayout({
  children,
  params: { locale }
}: {
  children: React.ReactNode;
  params: { locale: string };
}) {
  return (
    <html lang={locale} suppressHydrationWarning>
      <body className="min-h-screen bg-gray-50 antialiased">
        <I18nProvider locale={locale}>
          <Web3Provider>
            <QueryProvider>
              {children}
              <Toaster />
            </QueryProvider>
          </Web3Provider>
        </I18nProvider>
      </body>
    </html>
  );
}
```

```typescript
// components/providers/Web3Provider.tsx

'use client';

import { createWeb3Modal } from '@web3modal/wagmi/react';
import { http, createConfig, fallback } from 'wagmi';
import { mainnet, polygon, polygonAmoy } from 'wagmi/chains';
import { injected, coinbaseWallet, walletConnect } from 'wagmi/connectors';
import { QueryClient } from '@tanstack/react-query';
import { WagmiProvider } from 'wagmi';

const projectId = process.env.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID || '';

const config = createConfig({
  chains: [polygon, polygonAmoy],
  transports: {
    [polygon.id]: fallback([
      http('https://polygon-rpc.com'),
      http('https://rpc.ankr.com/polygon'),
    ]),
    [polygonAmoy.id]: fallback([
      http('https://rpc-amoy.polygon.technology'),
      http('https://polygon-amoy.public.blastapi.io'),
    ]),
  },
  connectors: [
    injected(),
    coinbaseWallet({ projectId, chains: [polygon, polygonAmoy] }),
    walletConnect({ projectId, chains: [polygon, polygonAmoy] }),
  ],
  ssr: true,
});

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 30, // 30ì´ˆ
      refetchOnWindowFocus: false,
      retry: 3,
    },
  },
});

export function Web3Provider({ children }: { children: React.ReactNode }) {
  return (
    <WagmiProvider config={config} queryClient={queryClient}>
      {children}
    </WagmiProvider>
  );
}
```

### 3.4 íŠ¸ë ˆì´ë”© ì»´í¬ë„ŒíŠ¸

íŠ¸ë ˆì´ë”© ì»´í¬ë„ŒíŠ¸ëŠ” ì‚¬ìš©ìê°€ ì˜¤ë”ë¥¼ ë°°ì¹˜í•˜ê³ , ì˜¤ë”ë¶ì„ ì‹œê°í™”í•˜ê³ , í¬ì§€ì…˜ì„ ì¶”ì í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ì˜ í•µì‹¬ ê¸°ëŠ¥ì  ë¶€ë¶„ì…ë‹ˆë‹¤. OrderForm ì»´í¬ë„ŒíŠ¸ëŠ” ì˜¤ë” ìƒì„±ì˜ ì „ì²´ ë¡œì§ì„ ìº¡ìŠí™”í•˜ì—¬, ì…ë ¥ ê²€ì¦, ê°€ê²© ê³„ì‚°, EIP-712 ì„œëª…ì„ í¬í•¨í•©ë‹ˆë‹¤.

```typescript
// components/features/trading/OrderForm.tsx

'use client';

import { useState, useCallback } from 'react';
import { useAccount, useWriteContract, useSignTypedData } from 'wagmi';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { parseEther, formatEther } from 'viem';
import { Order, Signature } from '@/types/order';
import { useMarket } from '@/lib/hooks/useMarketData';
import { useSiwe } from '@/lib/hooks/useSiwe';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { useTranslations } from 'next-intl';

interface OrderFormProps {
  marketAddress: `0x${string}`;
  outcomeIndex: number;
  isBuy: boolean;
  onSuccess?: () => void;
}

export function OrderForm({
  marketAddress,
  outcomeIndex,
  isBuy,
  onSuccess
}: OrderFormProps) {
  const t = useTranslations('trading');
  const { address, isConnected } = useAccount();
  const { signTypedDataAsync } = useSignTypedData();
  const { writeContractAsync } = useWriteContract();
  const queryClient = useQueryClient();
  const { nonce, verifySignature } = useSiwe();

  const [amount, setAmount] = useState('');
  const [price, setPrice] = useState('');
  const [slippage, setSlippage] = useState('2');

  const { data: market } = useMarket(marketAddress);
  const { data: allowance } = useQuery({
    queryKey: ['allowance', marketAddress, address],
    queryFn: () => fetchAllowance(marketAddress, address!),
    enabled: !!address,
  });

  const createOrderMutation = useMutation({
    mutationFn: async (order: Order) => {
      // EIP-712ë¡œ ì˜¤ë” ì„œëª…
      const signature = await signTypedDataAsync({
        domain: {
          name: 'Foresight Market',
          version: '1',
          chainId: process.env.NEXT_PUBLIC_CHAIN_ID === '137' ? 137 : 80002,
          verifyingContract: marketAddress,
        },
        types: {
          Order: [
            { name: 'maker', type: 'address' },
            { name: 'outcome', type: 'uint256' },
            { name: 'isBuy', type: 'bool' },
            { name: 'price', type: 'uint128' },
            { name: 'amount', type: 'uint128' },
            { name: 'expires', type: 'uint64' },
            { name: 'nonce', type: 'uint64' },
          ],
        },
        message: order,
      });

      // Relayerì— ì œì¶œ
      const response = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order, signature }),
      });

      if (!response.ok) {
        throw new Error('Failed to submit order');
      }

      return response.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['orderBook', marketAddress] });
      onSuccess?.();
    },
  });

  const handleSubmit = useCallback(async () => {
    if (!isConnected || !address) {
      // ì§€ê°‘ ì—°ê²° íŠ¸ë¦¬ê±°
      return;
    }

    const order: Order = {
      maker: address,
      outcome: outcomeIndex,
      isBuy,
      price: parseEther(price) as unknown as bigint,
      amount: parseEther(amount) as unknown as bigint,
      expires: BigInt(Math.floor(Date.now() / 1000) + 3600), // 1ì‹œê°„
      nonce: BigInt(nonce),
    };

    await createOrderMutation.mutateAsync(order);
  }, [isConnected, address, amount, price, outcomeIndex, isBuy, nonce]);

  const estimatedCost = parseFloat(amount) * parseFloat(price);
  const maxSlippageAmount = estimatedCost * (1 + parseFloat(slippage) / 100);

  if (!isConnected) {
    return (
      <div className="p-4 text-center">
        <p className="text-gray-500">{t('connectWalletPrompt')}</p>
      </div>
    );
  }

  return (
    <div className="space-y-4 p-4">
      <div className="flex items-center justify-between">
        <span className="text-sm text-gray-500">
          {isBuy ? t('buy') : t('sell')} {t('outcome')} {outcomeIndex}
        </span>
        <span className="text-sm text-gray-500">
          {t('maxSlippage')}: {slippage}%
        </span>
      </div>

      <div className="space-y-2">
        <label className="block text-sm font-medium">{t('price')}</label>
        <div className="relative">
          <Input
            type="number"
            value={price}
            onChange={(e) => setPrice(e.target.value)}
            placeholder="0.00"
            step="0.01"
            min="0"
            max="1"
          />
          <span className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
            USDC
          </span>
        </div>
      </div>

      <div className="space-y-2">
        <label className="block text-sm font-medium">{t('amount')}</label>
        <Input
          type="number"
          value={amount}
          onChange={(e) => setAmount(e.target.value)}
          placeholder="0.00"
          step="0.01"
          min="0"
        />
      </div>

      <div className="rounded-lg bg-gray-50 p-3 space-y-2">
        <div className="flex justify-between text-sm">
          <span className="text-gray-500">{t('estimated')}</span>
          <span className="font-medium">
            ${estimatedCost.toFixed(2)} USDC
          </span>
        </div>
        <div className="flex justify-between text-sm">
          <span className="text-gray-500">{t('maxSlippage')}</span>
          <span className="font-medium">
            ${maxSlippageAmount.toFixed(2)} USDC
          </span>
        </div>
      </div>

      <Button
        onClick={handleSubmit}
        loading={createOrderMutation.isPending}
        disabled={!amount || !price}
        className="w-full"
        variant={isBuy ? 'primary' : 'secondary'}
      >
        {isBuy ? t('placeBuyOrder') : t('placeSellOrder')}
      </Button>

      {createOrderMutation.isError && (
        <p className="text-sm text-red-500">
          {t('orderFailed')}: {(createOrderMutation.error as Error).message}
        </p>
      )}
    </div>
  );
}
```

### 3.5 êµ­ì œí™” (i18n)

êµ­ì œí™” ì‹œìŠ¤í…œì€ next-intlì„ ì‚¬ìš©í•˜ì—¬ ì§€ì›ë˜ëŠ” 5ê°œ ì–¸ì–´ ì „ì²´ì— ë²ˆì—­ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ë©”ì‹œì§€ íŒŒì¼ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(common, trading, market, portfolio ë“±)ë³„ë¡œ êµ¬ì„±ë˜ì–´ ì¡°ì§í™”ì™€ ì§€ì—° ë¡œë”©ëœ ë²ˆì—­ì˜ ë²ˆì—­ ë¡œë”©ì„ ìš©ì´í•˜ê²Œ í•©ë‹ˆë‹¤.

```json
// messages/ko.json

{
  "common": {
    "appName": "Foresight",
    "connected": "ì—°ê²°ë¨",
    "disconnected": "ì—°ê²° í•´ì œë¨",
    "connectWallet": "ì§€ê°‘ ì—°ê²°",
    "loading": "ë¡œë”© ì¤‘...",
    "error": "ì˜¤ë¥˜",
    "success": "ì„±ê³µ",
    "cancel": "ì·¨ì†Œ",
    "confirm": "í™•ì¸",
    "save": "ì €ì¥",
    "delete": "ì‚­ì œ",
    "edit": "ìˆ˜ì •",
    "viewAll": "ëª¨ë‘ ë³´ê¸°"
  },
  "trading": {
    "buy": "ë§¤ìˆ˜",
    "sell": "ë§¤ë„",
    "price": "ê°€ê²©",
    "amount": "ìˆ˜ëŸ‰",
    "outcome": "ê²°ê³¼",
    "placeBuyOrder": "ë§¤ìˆ˜ ì£¼ë¬¸ ì œì¶œ",
    "placeSellOrder": "ë§¤ë„ ì£¼ë¬¸ ì œì¶œ",
    "orderSubmitted": "ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤",
    "orderFailed": "ì£¼ë¬¸ ì‹¤íŒ¨",
    "connectWalletPrompt": "ì§€ê°‘ì„ ì—°ê²°í•´ì£¼ì„¸ìš”",
    "estimated": "ì˜ˆìƒ",
    "maxSlippage": "ìµœëŒ€ ìŠ¬ë¦¬í”¼ì§€",
    "orderBook": "í˜¸ê°€ì°½",
    "recentTrades": "ìµœê·¼ ê±°ë˜",
    "myOrders": "ë‚´ ì£¼ë¬¸",
    "noOrders": "ì£¼ë¬¸ ì—†ìŒ",
    "orderExpires": "ë§Œë£Œ"
  },
  "market": {
    "createMarket": "ì‹œì¥ ìƒì„±",
    "marketDetails": "ì‹œì¥ ìƒì„¸",
    "resolutionDate": "í•´ê²° ë‚ ì§œ",
    "status": "ìƒíƒœ",
    "statusActive": "í™œì„±",
    "statusResolved": "í•´ê²°ë¨",
    "statusPaused": "ì¼ì‹œ ì¤‘ì§€ë¨",
    "volume": "ê±°ë˜ëŸ‰",
    "liquidity": "ìœ ë™ì„±",
    "traders": "íŠ¸ë ˆì´ë”",
    "discussions": "í† ë¡ ",
    "forum": "í¬ëŸ¼"
  },
  "portfolio": {
    "positions": "í¬ì§€ì…˜",
    "history": "ë‚´ì—­",
    "pnl": "ì†ìµ",
    "totalValue": "ì´ ê°€ì¹˜",
    "realizedPnL": "ì‹¤í˜„ ì†ìµ",
    "unrealizedPnL": "ë¯¸ì‹¤í˜„ ì†ìµ"
  }
}
```

```typescript
// middleware.ts

import createMiddleware from "next-intl/middleware";
import { locales, defaultLocale } from "./i18n/config";

export default createMiddleware({
  locales,
  defaultLocale,
  localePrefix: "always",
});

export const config = {
  matcher: ["/", "/(zh-CN|en|es|fr|ko)/:path*"],
};
```

---

## 4. Relayer ì„œë¹„ìŠ¤

### 4.1 Relayer ì•„í‚¤í…ì²˜

Relayer ì„œë¹„ìŠ¤ëŠ” ì˜¤í”„ì²´ì¸ ì•„í‚¤í…ì²˜ì˜ í•µì‹¬ êµ¬ì„± ìš”ì†Œë¡œ, ê³ ì„±ëŠ¥ ì˜¤ë” ì²˜ë¦¬ì™€ ì˜¤ë”ë¶ ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤. Node.jsì™€ TypeScriptë¡œ êµ¬ì¶•ëœ RelayerëŠ” Redis ê¸°ë°˜ ì´ë²¤íŠ¸ ì¤‘ì‹¬ ì•„í‚¤í…ì²˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ ë‚´ ì§€ì†ì„±ê³¼ ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ë°°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤. ì„œë¹„ìŠ¤ëŠ” ì¡°ìœ¨ëœ ë°©ì‹ìœ¼ë¡œ ì‘ë™í•˜ì—¬ ë¶€ë“œëŸ½ê³  ë¹ ë¥¸ êµí™˜ ê²½í—˜ì„ ì œê³µí•˜ê¸° ìœ„í•´ ì—¬ëŸ¬ ì „ë¬¸ ëª¨ë“ˆë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.

Relayer ì•„í‚¤í…ì²˜ëŠ” ìˆ˜í‰ì  í™•ì¥ì„ ìœ„í•´ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ê° Relayer ì¸ìŠ¤í„´ìŠ¤ëŠ” ì´ˆë‹¹ ìˆ˜ì²œ ê°œì˜ ì˜¤ë”ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìœ¼ë©°, ë¶€í•˜ ë¶„ì‚° ì¥ì¹˜ ë’¤ì— ì—¬ëŸ¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°°í¬í•˜ì—¬ ìš©ëŸ‰ì„ ëŠ˜ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Redis íŒŒí‹°ì…”ë‹ì€ ì—¬ëŸ¬ ë…¸ë“œ ê°„ì— ë°ì´í„° ë¶€í•˜ë¥¼ ë¶„ì‚°í•˜ê³ , WebSocket ì—°ê²°ì€ ì¸ìŠ¤í„´ìŠ¤ ê°„ì— ê· í˜•ì„ ì´ë£¨ì–´ ê° ì‚¬ìš©ìì—ê²Œ ì•ˆì •ì ì¸ ì—°ê²°ì„ ìœ ì§€í•©ë‹ˆë‹¤.

ì˜¤ë”ë¶ ê´€ë¦¬ ëª¨ë“ˆì€ ëª¨ë“  í™œì„± ì‹œì¥ì„ ìœ„í•œ ì˜¤ë”ë¶ ë°ì´í„° êµ¬ì¡°ë¥¼ ë©”ëª¨ë¦¬ì— ìœ ì§€í•©ë‹ˆë‹¤. ì´ êµ¬ì¡°ëŠ” ë¹ ë¥¸ ë§¤ì¹­ ì—°ì‚°ì— ìµœì í™”ë˜ì–´, ê°€ê²© ê²€ìƒ‰ì—ëŠ” ê· í˜• ì¡íŒ íŠ¸ë¦¬(AVL ë˜ëŠ” Red-Black)ë¥¼, í•´ì‹œë³„ ì§ì ‘ ì ‘ê·¼ì—ëŠ” ë§µì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë°ì´í„°ëŠ” ì£¼ê¸°ì ìœ¼ë¡œ ë””ìŠ¤í¬ì™€ Supabaseì— ë°±ì—…ë˜ì–´ ë‚´êµ¬ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

ë§¤ì¹­ ì—”ì§„ì€ ê°€ê²©-ì‹œê°„ ë§¤ì¹­ ì•Œê³ ë¦¬ì¦˜ì„ êµ¬í˜„í•©ë‹ˆë‹¤. ìƒˆ ì˜¤ë”ê°€ ë„ì°©í•˜ë©´ ì—”ì§„ì€ ì¦‰ì‹œ ê¸°ì¡´ ì˜¤ë”ë¶ì—ì„œ í˜¸í™˜ë˜ëŠ” ìƒëŒ€ë°©ì„ ì°¾ìŠµë‹ˆë‹¤. ë§¤ì¹­ì´ ë°œê²¬ë˜ë©´ ì˜¤ë”ê°€ ë¶€ë¶„ì ìœ¼ë¡œ ë˜ëŠ” ì™„ì „íˆ ì‹¤í–‰ë˜ê³ , ì •ì‚°ì„ ìœ„í•´ ë¸”ë¡ì²´ì¸ íŠ¸ëœì­ì…˜ì´ ìƒì„±ë©ë‹ˆë‹¤. ì—”ì§„ì€ ë˜í•œ ì‹¤í–‰ëœ ì˜¤ë”ì˜ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ìœ ì§€í•˜ì—¬ ë‚´ì—­ ë° í†µê³„ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

ì´ë²¤íŠ¸ ìˆ˜ì§‘ ëª¨ë“ˆì€ Polygon ë…¸ë“œì— ëŒ€í•œ WebSocket ì—°ê²°ì„ í†µí•´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¸”ë¡ì²´ì¸ ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹ í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ì´ë²¤íŠ¸ëŠ” ì˜¤ë”ë¶ ì—…ë°ì´íŠ¸, ì—°ê²°ëœ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼, ì‹œì¥ í†µê³„ ì—…ë°ì´íŠ¸ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤. ëª¨ë“ˆì€ ê³„ì•½ì„œ ì£¼ì†Œë³„ í•„í„°ë§ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•˜ì—¬ ê´€ë ¨ ì´ë²¤íŠ¸ë§Œ ìˆ˜ì‹ í•©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Relayer Service Architecture                      â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      API Gateway Layer                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  REST API   â”‚  â”‚  WebSocket  â”‚  â”‚  Admin/Health Endpoints â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  (Express)  â”‚  â”‚  (Socket.io)â”‚  â”‚  (Express)              â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                â”‚                                           â”‚
â”‚            â–¼                â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Authentication Layer                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              SIWE Verification Module                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Validate nonce        â€¢ Verify signature EIP-712     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Check expiry          â€¢ Rate limit by IP/user        â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                                    â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Core Business Logic                          â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Order Manager   â”‚ â”‚ Matching Engine â”‚ â”‚ Event Processor â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Validation    â”‚ â”‚ â€¢ Price-time    â”‚ â”‚ â€¢ Block events  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Deduplication â”‚ â”‚ â€¢ Batch exec    â”‚ â”‚ â€¢ State sync    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Redis cache   â”‚ â”‚ â€¢ Slippage checkâ”‚ â”‚ â€¢ Notifications â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Transaction     â”‚ â”‚ Stats Calculatorâ”‚ â”‚ Order Sync      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ Builder         â”‚ â”‚ â€¢ OHLCV candles â”‚ â”‚ â€¢ DB persistenceâ”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Batch orders  â”‚ â”‚ â€¢ Volume metricsâ”‚ â”‚ â€¢ History replayâ”‚   â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ Gas estimationâ”‚ â”‚ â€¢ Liquidity     â”‚ â”‚ â€¢ Recovery      â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚            â–¼                       â–¼                       â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚     Redis       â”‚ â”‚   Supabase      â”‚ â”‚   Blockchain    â”‚            â”‚
â”‚  â”‚   Cluster       â”‚ â”‚   PostgreSQL    â”‚ â”‚   (Wallet)      â”‚            â”‚
â”‚  â”‚   â€¢ Order Book  â”‚ â”‚   â€¢ Historical  â”‚            â”‚            â”‚
â”‚  â”‚   â€¢ Rate Limit  â”‚ â”‚   â€¢ Analytics   â”‚            â–¼            â”‚
â”‚  â”‚   â€¢ Caching     â”‚ â”‚   â€¢ User Data   â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  Send Transactionâ”‚      â”‚
â”‚                                              â”‚  â€¢ Batch signing  â”‚      â”‚
â”‚                                              â”‚  â€¢ Gas optim.     â”‚      â”‚
â”‚                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ë§¤ì¹­ ì—”ì§„ ì½”ë“œ

ë§¤ì¹­ ì—”ì§„ì€ Relayerì˜ í•µì‹¬ìœ¼ë¡œ, ì‚¬ìš©ìì˜ ì˜¤ë”ë¥¼ ì‹¤í–‰í•˜ëŠ” ì•Œê³ ë¦¬ì¦˜ì„ êµ¬í˜„í•©ë‹ˆë‹¤. ì•Œê³ ë¦¬ì¦˜ì€ ê°€ê²©-ì‹œê°„ ìš°ì„ ìˆœìœ„ ì›ì¹™ì„ ë”°ë¥´ë©°, ìµœìƒì˜ ê°€ê²©ì˜ ì˜¤ë”ê°€ ë¨¼ì € ì‹¤í–‰ë˜ê³  ë™ì¼í•œ ê°€ê²©ì˜ ì˜¤ë”ëŠ” ë„ì°© ìˆœì„œì— ë”°ë¼ ì‹¤í–‰ë©ë‹ˆë‹¤.

```typescript
// services/relayer/src/matching-engine/engine.ts

import { Order, OrderSide, OrderStatus } from "../models/order";
import { Trade } from "../models/trade";
import { Redis } from "ioredis";
import { logger } from "../utils/logger";

interface MatchResult {
  trades: Trade[];
  remainingOrder: Order | null;
  errors: string[];
}

export class MatchingEngine {
  private redis: Redis;
  private orderBooks: Map<string, Order[]>;

  constructor(redis: Redis) {
    this.redis = redis;
    this.orderBooks = new Map();
  }

  async processOrder(order: Order): Promise<MatchResult> {
    const result: MatchResult = {
      trades: [],
      remainingOrder: null,
      errors: [],
    };

    try {
      const orderBookKey = `orderbook:${order.marketAddress}:${order.outcome}`;
      const oppositeSide = order.isBuy ? "sell" : "buy";
      const orderBook = await this.getOrderBook(orderBookKey, oppositeSide);

      if (orderBook.length === 0) {
        await this.addToOrderBook(orderBookKey, order);
        result.remainingOrder = order;
        return result;
      }

      let remainingAmount = order.amount;

      for (const restingOrder of orderBook) {
        if (remainingAmount === 0n) break;

        if (!this.canMatch(order, restingOrder)) {
          continue;
        }

        const matchAmount = this.calculateMatchAmount(order, remainingAmount, restingOrder);
        const matchPrice = this.determineExecutionPrice(order, restingOrder);

        const trade = await this.executeTrade(order, restingOrder, matchAmount, matchPrice);

        result.trades.push(trade);
        remainingAmount -= matchAmount;

        if (restingOrder.amount === matchAmount) {
          await this.removeOrder(orderBookKey, restingOrder);
        } else {
          await this.updateOrderAmount(
            orderBookKey,
            restingOrder,
            restingOrder.amount - matchAmount
          );
        }
      }

      if (remainingAmount > 0) {
        const updatedOrder = { ...order, amount: remainingAmount };
        await this.addToOrderBook(orderBookKey, updatedOrder);
        result.remainingOrder = updatedOrder;
      }

      await this.publishOrderBookUpdate(order.marketAddress, order.outcome);
    } catch (error) {
      logger.error("Matching engine error", { error, order });
      result.errors.push((error as Error).message);
    }

    return result;
  }

  private canMatch(incoming: Order, resting: Order): boolean {
    if (incoming.isBuy) {
      return incoming.price >= resting.price;
    } else {
      return incoming.price <= resting.price;
    }
  }

  private calculateMatchAmount(incoming: Order, incomingRemaining: bigint, resting: Order): bigint {
    const minAmount = incomingRemaining < resting.amount ? incomingRemaining : resting.amount;
    return minAmount;
  }

  private determineExecutionPrice(incoming: Order, resting: Order): bigint {
    if (incoming.timestamp < resting.timestamp) {
      return incoming.price;
    } else {
      return resting.price;
    }
  }

  private async executeTrade(
    maker: Order,
    taker: Order,
    amount: bigint,
    price: bigint
  ): Promise<Trade> {
    const trade: Trade = {
      id: await this.generateTradeId(),
      marketAddress: maker.marketAddress,
      outcomeIndex: maker.outcome,
      price,
      amount,
      makerAddress: maker.maker,
      takerAddress: taker.maker,
      timestamp: Date.now(),
      transactionHash: null,
    };

    await this.saveTrade(trade);

    this.logger.info("Trade executed", {
      tradeId: trade.id,
      market: trade.marketAddress,
      amount: amount.toString(),
      price: price.toString(),
    });

    return trade;
  }

  private async getOrderBook(key: string, side: string): Promise<Order[]> {
    const data = await this.redis.hget(key, side);
    if (!data) return [];

    const orders: Order[] = JSON.parse(data);
    return this.sortOrderBook(orders);
  }

  private sortOrderBook(orders: Order[]): Order[] {
    return orders.sort((a, b) => {
      if (a.price !== b.price) {
        return Number(b.price - a.price);
      }
      return Number(a.timestamp - b.timestamp);
    });
  }
}
```

### 4.3 EIP-712 ì„œëª… ê´€ë¦¬

ì„œëª… ê²€ì¦ ì‹œìŠ¤í…œì€ Relayerì˜ ë³´ì•ˆì— ì¤‘ìš”í•©ë‹ˆë‹¤. ê° ì˜¤ë”ëŠ” ì˜¤ë”ë¶ì— ìˆ˜ë½ë˜ê¸° ì „ì— ìƒì„±ì(maker)ê°€ ì„œëª…í•´ì•¼ í•©ë‹ˆë‹¤. ê²€ì¦ì€ EIP-712 í‘œì¤€ì— ë”°ë¼ ìˆ˜í–‰ë˜ë©°, ì´ëŠ” íƒ€ì…í™”ëœ ë°ì´í„°ì˜ êµ¬ì¡°í™”ëœ ì„œëª…ì„ ìœ„í•œ í˜•ì‹ì„ ì •ì˜í•©ë‹ˆë‹¤.

```typescript
// services/relayer/src/utils/signature.ts

import { ethers } from "ethers";
import { Order } from "../models/order";

const EIP712_DOMAIN_TYPEHASH = ethers.id(
  "EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"
);

const ORDER_TYPEHASH = ethers.id(
  "Order(address maker,uint256 outcome,bool isBuy,uint128 price,uint128 amount,uint64 expires,uint64 nonce)"
);

export function hashOrder(order: Order): string {
  return ethers.keccak256(
    ethers.concat([
      ORDER_TYPEHASH,
      ethers.AbiCoder.defaultAbiCoder().encode(
        ["address", "uint256", "bool", "uint128", "uint128", "uint64", "uint64"],
        [
          order.maker,
          order.outcome,
          order.isBuy,
          order.price,
          order.amount,
          order.expires,
          order.nonce,
        ]
      ),
    ])
  );
}

export function hashDomain(
  name: string,
  version: string,
  chainId: bigint,
  verifyingContract: string
): string {
  return ethers.keccak256(
    ethers.concat([
      EIP712_DOMAIN_TYPEHASH,
      ethers.AbiCoder.defaultAbiCoder().encode(
        ["string", "string", "uint256", "address"],
        [name, version, chainId, verifyingContract]
      ),
    ])
  );
}

export function verifySignature(
  order: Order,
  signature: string,
  expectedSigner: string,
  chainId: bigint,
  verifyingContract: string
): boolean {
  try {
    const domainHash = hashDomain("Foresight Market", "1", chainId, verifyingContract);

    const orderHash = hashOrder(order);

    const messageHash = ethers.keccak256(ethers.concat(["0x1901", domainHash, orderHash]));

    const recoveredAddress = ethers.verifyMessage(ethers.getBytes(messageHash), signature);

    return recoveredAddress.toLowerCase() === expectedSigner.toLowerCase();
  } catch (error) {
    console.error("Signature verification failed", error);
    return false;
  }
}

export function parseSignature(signature: string): {
  v: number;
  r: string;
  s: string;
} {
  const sig = signature.startsWith("0x") ? signature.slice(2) : signature;
  if (sig.length !== 130) {
    throw new Error("Invalid signature length");
  }

  return {
    v: parseInt(sig.slice(128, 130), 16),
    r: "0x" + sig.slice(0, 64),
    s: "0x" + sig.slice(64, 128),
  };
}
```

### 4.4 ì‹¤ì‹œê°„ WebSocket ì„œë¹„ìŠ¤

WebSocket ì„œë¹„ìŠ¤ëŠ” ì‚¬ìš©ìê°€ ì˜¤ë”ë¶, ì‹¤í–‰ëœ ê±°ë˜, ì‹œì¥ ìƒíƒœ ë³€ê²½ì— ëŒ€í•œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ë°›ì„ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤. Socket.ioëŠ” ì—°ê²° ê´€ë¦¬ì— ì‚¬ìš©ë˜ë©°, ì‹œì¥ë³„ ë£¸ì„ ì‚¬ìš©í•˜ì—¬ ë©”ì‹œì§€ ë¶„ë°°ë¥¼ ìµœì í™”í•©ë‹ˆë‹¤.

```typescript
// services/relayer/src/websocket/handler.ts

import { Server as SocketServer, Socket } from "socket.io";
import { Redis } from "ioredis";
import { verifySignature } from "../utils/signature";
import { logger } from "../utils/logger";

interface AuthenticatedSocket extends Socket {
  userAddress?: string;
  subscribedMarkets?: Set<string>;
}

export class WebSocketHandler {
  private io: SocketServer;
  private redis: Redis;

  constructor(io: SocketServer, redis: Redis) {
    this.io = io;
    this.redis = redis;
    this.setupMiddleware();
    this.setupEventHandlers();
  }

  private setupMiddleware() {
    this.io.use(async (socket: AuthenticatedSocket, next) => {
      try {
        const address = socket.handshake.auth.address;
        const signature = socket.handshake.auth.signature;

        if (!address || !signature) {
          return next(new Error("Missing auth credentials"));
        }

        const nonce = await this.redis.get(`nonce:${address}`);
        if (!nonce) {
          return next(new Error("Invalid nonce"));
        }

        // ì‹¤ì œ ì„œëª… ê²€ì¦ì€ ì—¬ê¸°ì„œ ìˆ˜í–‰
        // nonce ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì™€ì„œ ê²€ì¦

        socket.userAddress = address.toLowerCase();
        socket.subscribedMarkets = new Set();

        next();
      } catch (error) {
        logger.error("WebSocket auth error", error);
        next(new Error("Authentication failed"));
      }
    });
  }

  private setupEventHandlers() {
    this.io.on("connection", (socket: AuthenticatedSocket) => {
      logger.info("Client connected", { address: socket.userAddress });

      socket.on("subscribe:market", async (marketAddress: string) => {
        const room = `market:${marketAddress.toLowerCase()}`;
        socket.join(room);
        socket.subscribedMarkets?.add(marketAddress.toLowerCase());

        const orderBook = await this.redis.hgetall(`orderbook:${marketAddress}`);
        const recentTrades = await this.redis.lrange(`trades:${marketAddress}`, 0, 49);

        socket.emit("market:snapshot", {
          orderBook: JSON.parse(orderBook.buy || "[]"),
          recentTrades: recentTrades.map((t) => JSON.parse(t)),
        });
      });

      socket.on("unsubscribe:market", (marketAddress: string) => {
        const room = `market:${marketAddress.toLowerCase()}`;
        socket.leave(room);
        socket.subscribedMarkets?.delete(marketAddress.toLowerCase());
      });

      socket.on("subscribe:orders", async () => {
        const room = `orders:${socket.userAddress}`;
        socket.join(room);
      });

      socket.on("subscribe:trades", async () => {
        const room = `trades:${socket.userAddress}`;
        socket.join(room);
      });

      socket.on("disconnect", () => {
        logger.info("Client disconnected", { address: socket.userAddress });
      });
    });
  }

  broadcastTrade(trade: any) {
    const marketRoom = `market:${trade.marketAddress.toLowerCase()}`;
    this.io.to(marketRoom).emit("trade:new", {
      id: trade.id,
      price: trade.price.toString(),
      amount: trade.amount.toString(),
      outcomeIndex: trade.outcomeIndex,
      maker: trade.makerAddress,
      taker: trade.takerAddress,
      timestamp: trade.timestamp,
    });

    const makerRoom = `trades:${trade.makerAddress.toLowerCase()}`;
    const takerRoom = `trades:${trade.takerAddress.toLowerCase()}`;
    this.io.to(makerRoom).emit("trade:own", trade);
    this.io.to(takerRoom).emit("trade:own", trade);
  }

  broadcastOrderBookUpdate(marketAddress: string, outcomeIndex: number) {
    const room = `market:${marketAddress.toLowerCase()}`;
    this.io.to(room).emit("orderbook:update", { outcomeIndex });
  }

  notifyOrderStatus(orderId: string, status: string, userAddress: string) {
    const room = `orders:${userAddress.toLowerCase()}`;
    this.io.to(room).emit("order:status", { orderId, status });
  }
}
```

---

## 5. API ì°¸ì¡°

### 5.1 API ì—”ë“œí¬ì¸íŠ¸

Foresightì˜ REST APIëŠ” í´ë¼ì´ì–¸íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì— í•„ìš”í•œ ëª¨ë“  ì‘ì—…ì„ ìœ„í•œ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤. APIëŠ” ë³´í˜¸ëœ ì—”ë“œë³´ì•ˆì„ ìœ„í•´ SIWE(Sign-In with Ethereum) ì¸ì¦ì„ ì‚¬ìš©í•˜ê³ , IP ì£¼ì†Œì™€ ì´ë”ë¦¬ì›€ ì£¼ì†Œë³„ë¡œ ë ˆì´íŠ¸ ë¦¬ë°‹ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

```
https://api.foresight.market/

â”œâ”€â”€ /api/
â”‚   â”œâ”€â”€ siwe/
â”‚   â”‚   â”œâ”€â”€ GET    /nonce          â†’ ì¸ì¦ì„ ìœ„í•œ nonce ìƒì„±
â”‚   â”‚   â”œâ”€â”€ POST   /verify         â†’ ì„œëª… ê²€ì¦
â”‚   â”‚   â””â”€â”€ POST   /logout         â†’ ì„¸ì…˜ ë¬´íš¨í™”
â”‚   â”‚
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ GET    /session        â†’ í™œì„± ì„¸ì…˜ ì¡°íšŒ
â”‚   â”‚   â””â”€â”€ POST   /refresh        â†’ í† í° ê°±ì‹ 
â”‚   â”‚
â”‚   â”œâ”€â”€ markets/
â”‚   â”‚   â”œâ”€â”€ GET    /               â†’ ì‹œì¥ ëª©ë¡
â”‚   â”‚   â”œâ”€â”€ GET    /:address       â†’ ì‹œì¥ ìƒì„¸
â”‚   â”‚   â”œâ”€â”€ GET    /:address/book  â†’ ì˜¤ë”ë¶
â”‚   â”‚   â”œâ”€â”€ GET    /:address/tradesâ†’ ê±°ë˜ ë‚´ì—­
â”‚   â”‚   â”œâ”€â”€ GET    /:address/candlesâ†’ OHLCV ë°ì´í„°
â”‚   â”‚   â””â”€â”€ POST   /               â†’ ì‹œì¥ ìƒì„± (ê´€ë¦¬ì)
â”‚   â”‚
â”‚   â”œâ”€â”€ orders/
â”‚   â”‚   â”œâ”€â”€ GET    /               â†’ ì‚¬ìš©ì ì˜¤ë” ëª©ë¡
â”‚   â”‚   â”œâ”€â”€ GET    /:orderId       â†’ ì˜¤ë” ìƒì„¸
â”‚   â”‚   â”œâ”€â”€ POST   /               â†’ ì„œëª…ëœ ì˜¤ë” ì œì¶œ
â”‚   â”‚   â”œâ”€â”€ DELETE /:orderId       â†’ ì˜¤ë” ì·¨ì†Œ
â”‚   â”‚   â””â”€â”€ POST   /batch          â†’ ì—¬ëŸ¬ ì˜¤ë” ì œì¶œ
â”‚   â”‚
â”‚   â”œâ”€â”€ trades/
â”‚   â”‚   â”œâ”€â”€ GET    /               â†’ ì‚¬ìš©ì ê±°ë˜ ëª©ë¡
â”‚   â”‚   â””â”€â”€ GET    /:tradeId       â†’ ê±°ë˜ ìƒì„¸
â”‚   â”‚
â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ GET    /profile        â†’ ì‚¬ìš©ì í”„ë¡œí•„
â”‚   â”‚   â”œâ”€â”€ PATCH  /profile        â†’ í”„ë¡œí•„ ì—…ë°ì´íŠ¸
â”‚   â”‚   â”œâ”€â”€ GET    /portfolio      â†’ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤
â”‚   â”‚   â”œâ”€â”€ GET    /positions      â†’ ë¯¸ì²­ì‚° í¬ì§€ì…˜
â”‚   â”‚   â”œâ”€â”€ GET    /history        â†’ ì „ì²´ ë‚´ì—­
â”‚   â”‚   â””â”€â”€ GET    /stats          â†’ ì‚¬ìš©ì í†µê³„
â”‚   â”‚
â”‚   â”œâ”€â”€ user-follows/
â”‚   â”‚   â”œâ”€â”€ GET    /               â†’ êµ¬ë… ëª©ë¡
â”‚   â”‚   â”œâ”€â”€ POST   /               â†’ ì‚¬ìš©ì íŒ”ë¡œìš°
â”‚   â”‚   â”œâ”€â”€ DELETE /:userAddress   â†’ íŒ”ë¡œìš° ì·¨ì†Œ
â”‚   â”‚   â””â”€â”€ GET    /counts         â†’ íŒ”ë¡œì›Œ ì¹´ìš´íŠ¸
â”‚   â”‚
â”‚   â”œâ”€â”€ discussions/
â”‚   â”‚   â”œâ”€â”€ GET    /               â†’ í† ë¡  ëª©ë¡
â”‚   â”‚   â”œâ”€â”€ POST   /               â†’ í† ë¡  ìƒì„±
â”‚   â”‚   â”œâ”€â”€ GET    /:id            â†’ í† ë¡  ìƒì„¸
â”‚   â”‚   â””â”€â”€ DELETE /:id            â†’ í† ë¡  ì‚­ì œ
â”‚   â”‚
â”‚   â”œâ”€â”€ forum/
â”‚   â”‚   â”œâ”€â”€ GET    /               â†’ ìŠ¤ë ˆë“œ ëª©ë¡
â”‚   â”‚   â”œâ”€â”€ POST   /               â†’ ìŠ¤ë ˆë“œ ìƒì„±
â”‚   â”‚   â”œâ”€â”€ GET    /:id            â†’ ìŠ¤ë ˆë“œ ìƒì„¸
â”‚   â”‚   â”œâ”€â”€ POST   /:id/comments   â†’ ëŒ“ê¸€ ì¶”ê°€
â”‚   â”‚   â”œâ”€â”€ POST   /:id/vote       â†’ ìŠ¤ë ˆë“œ íˆ¬í‘œ
â”‚   â”‚   â””â”€â”€ POST   /comments/:id/voteâ†’ ëŒ“ê¸€ íˆ¬í‘œ
â”‚   â”‚
â”‚   â””â”€â”€ analytics/
â”‚       â”œâ”€â”€ GET    /volume         â†’ ê±°ë˜ëŸ‰ ë°ì´í„°
â”‚       â”œâ”€â”€ GET    /leaderboard    â†’ íŠ¸ë ˆì´ë” ìˆœìœ„
â”‚       â””â”€â”€ GET    /trending       â†’ íŠ¸ë Œë”© ì‹œì¥
```

### 5.2 ì—”ë“œí¬ì¸íŠ¸ ìƒì„¸ ë¬¸ì„œ

**SIWE ì¸ì¦ (Authentication)**

```
GET /api/siwe/nonce
```

SIWE ì¸ì¦ì„ ìœ„í•´ ì•”í˜¸í™”ëœ nonceë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ nonceëŠ” IP ì£¼ì†Œì— ë°”ì¸ë”©ë˜ë©° 10ë¶„ í›„ ë§Œë£Œë©ë‹ˆë‹¤.

**ì‘ë‹µ:**

```json
{
  "nonce": "0x1234567890abcdef",
  "expiresAt": "2025-01-15T10:20:00Z"
}
```

```
POST /api/siwe/verify
```

ì´ë”ë¦¬ì›€ ì„œëª…ì„ ê²€ì¦í•˜ê³  ì„¸ì…˜ì„ ì„¤ì •í•©ë‹ˆë‹¤.

**ìš”ì²­ ë³¸ë¬¸:**

```json
{
  "message": {
    "domain": "foresight.market",
    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f8bEb1",
    "statement": "Sign in to Foresight",
    "uri": "https://foresight.market",
    "version": "1",
    "chainId": 137,
    "nonce": "0x1234567890abcdef",
    "issuedAt": "2025-01-15T10:10:00Z"
  },
  "signature": "0x..."
}
```

**ì‘ë‹µ:**

```json
{
  "user": {
    "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f8bEb1",
    "ensName": null,
    "avatarUrl": null
  },
  "sessionToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**ì‹œì¥ (Markets)**

```
GET /api/markets
```

í˜ì´ì§€ë„¤ì´ì…˜ ë° í•„í„°ë§ê³¼ í•¨ê»˜ ì‹œì¥ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.

**ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°:**
| íŒŒë¼ë¯¸í„° | íƒ€ì… | ì„¤ëª… |
|---------|------|------|
| page | number | í˜„ì¬ í˜ì´ì§€ (ê¸°ë³¸ê°’: 1) |
| limit | number | í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜ (ê¸°ë³¸ê°’: 20, ìµœëŒ€: 100) |
| status | string | ìƒíƒœë³„ í•„í„° (active, resolved, paused) |
| category | string | ì‹œì¥ ì¹´í…Œê³ ë¦¬ |
| sortBy | string | ì •ë ¬ (volume, creationTime, endTime) |
| sortOrder | string | ìˆœì„œ (asc, desc) |

**ì‘ë‹µ:**

```json
{
  "data": [
    {
      "address": "0x1234...5678",
      "question": "Will Bitcoin exceed $100,000 by end of 2025?",
      "outcomes": ["Yes", "No"],
      "status": "active",
      "volume": 1250000.5,
      "liquidity": 850000.0,
      "traderCount": 342,
      "creationTimestamp": 1705312800000,
      "resolutionDate": 1736848800000,
      "category": "crypto"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 156,
    "totalPages": 8
  }
}
```

```
GET /api/markets/:address/book
```

íŠ¹ì • ì‹œì¥ì„ ìœ„í•œ ì˜¤ë”ë¶ì„ ì¡°íšŒí•©ë‹ˆë‹¤.

**ì‘ë‹µ:**

```json
{
  "marketAddress": "0x1234...5678",
  "bids": [
    {
      "price": "0.65",
      "amount": "1000",
      "total": "650",
      "maker": "0xabcd...efgh"
    },
    {
      "price": "0.64",
      "amount": "2500",
      "total": "1600",
      "maker": "0xijkl...mnop"
    }
  ],
  "asks": [
    {
      "price": "0.66",
      "amount": "1500",
      "total": "990",
      "maker": "0xqrst...uvwx"
    }
  ],
  "spread": "0.01",
  "spreadPercent": "1.54%"
}
```

```
GET /api/markets/:address/candles
```

ì°¨íŠ¸ìš© OHLCV ì°¨ëª©çƒ› ë°ì´í„°ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

**ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°:**
| íŒŒë¼ë¯¸í„° | íƒ€ì… | ì„¤ëª… |
|---------|------|------|
| resolution | string | íƒ€ì„í”„ë ˆì„ (1m, 5m, 15m, 1h, 4h, 1d, 1w) |
| from | number | ì‹œì‘ íƒ€ì„ìŠ¤íƒ¬í”„ |
| to | number | ì¢…ë£Œ íƒ€ì„ìŠ¤íƒ¬í”„ |
| outcomeIndex | number | ê²°ê³¼ ì¸ë±ìŠ¤ (ì„ íƒ) |

**ì‘ë‹µ:**

```json
{
  "marketAddress": "0x1234...5678",
  "resolution": "1h",
  "candles": [
    {
      "timestamp": 1705312800000,
      "open": "0.60",
      "high": "0.65",
      "low": "0.59",
      "close": "0.64",
      "volume": 45000,
      "tradeCount": 156
    }
  ]
}
```

**ì˜¤ë” (Orders)**

```
POST /api/orders
```

ì²˜ë¦¬ë¥¼ ìœ„í•´ ì„œëª…ëœ ì˜¤ë”ë¥¼ ì œì¶œí•©ë‹ˆë‹¤.

**ìš”ì²­ ë³¸ë¬¸:**

```json
{
  "order": {
    "maker": "0x742d35Cc6634C0532925a3b844Bc9e7595f8bEb1",
    "outcome": 0,
    "isBuy": true,
    "price": "0.650000000000000000",
    "amount": "1000000000000000000",
    "expires": 1705316400,
    "nonce": 42
  },
  "signature": "0xabcd...1234"
}
```

**ì‘ë‹µ:**

```json
{
  "orderId": "0x1234567890abcdef...",
  "status": "received",
  "estimatedExecutionTime": 150,
  "message": "Order received and queued for processing"
}
```

**ì‚¬ìš©ì (User)**

```
GET /api/user/portfolio
```

ì‚¬ìš©ìì˜ ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.

**ì‘ë‹µ:**

```json
{
  "address": "0x742d35Cc6634C0532925a3b844Bc9e7595f8bEb1",
  "totalValue": 15420.5,
  "positions": [
    {
      "marketAddress": "0x1234...5678",
      "marketQuestion": "Will Bitcoin exceed $100,000 by end of 2025?",
      "outcome": 0,
      "outcomeLabel": "Yes",
      "quantity": 1000,
      "avgPrice": 0.55,
      "currentPrice": 0.65,
      "unrealizedPnL": 100.0,
      "realizedPnL": 25.5
    }
  ],
  "availableBalance": 5420.5,
  "lockedInOrders": 5000.0
}
```

### 5.3 ë ˆì´íŠ¸ ë¦¬ë°‹

APIëŠ” ìŠ¬ë¼ì´ë”© ìœˆë„ìš° ê¸°ë°˜ ë ˆì´íŠ¸ ë¦¬ë°‹ ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤. ì œí•œì€ ê³µê°œ ì—”ë“œí¬ì¸íŠ¸ì—ëŠ” IP ì£¼ì†Œë³„ë¡œ, ì¸ì¦ëœ ì—”ë“œí¬ì¸íŠ¸ì—ëŠ” ì´ë”ë¦¬ì›€ ì£¼ì†Œë³„ë¡œ ì ìš©ë©ë‹ˆë‹¤.

| ë ˆë²¨     | ë¶„ë‹¹ ìš”ì²­ìˆ˜ | ìš©ë„                  |
| -------- | ----------- | --------------------- |
| strict   | 5           | ì¸ì¦, ë¯¼ê°í•œ ì‘ì—…     |
| moderate | 20          | ì˜¤ë” ìƒì„±, ìˆ˜ì •       |
| relaxed  | 60          | ë¹ˆë²ˆí•œ ì¡°íšŒ, í´ë§     |
| lenient  | 120         | ê³µê°œ ì—”ë“œí¬ì¸íŠ¸, ë¶„ì„ |

ì‘ë‹µ í—¤ë”ì—ëŠ” ë ˆì´íŠ¸ ë¦¬ë°‹ ì •ë³´ê°€ í¬í•¨ë©ë‹ˆë‹¤:

```
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 45
X-RateLimit-Reset: 1705312800
```

---

## 6. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### 6.1 ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

Supabase(PostgreSQL) ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì‹œì¥ ë°ì´í„°ì˜ ì˜ì†ì  ì—­ì‚¬, ì‚¬ìš©ì ì •ë³´, ë©”íƒ€ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. ìŠ¤í‚¤ë§ˆëŠ” ë¹ˆë²ˆí•œ ë¶„ì„ ì¿¼ë¦¬ì— ìµœì í™”ë˜ì–´ ìˆê³ , ë†’ì€ ê±°ë˜ëŸ‰ ê±°ë˜ ë°ì´í„°ì—ëŠ” ì‹œê°„ ê¸°ë°˜ íŒŒí‹°ì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```sql
-- í•„ìˆ˜ í™•ì¥
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_cron";

-- Enum íƒ€ì…
CREATE TYPE order_status AS ENUM ('open', 'partial', 'filled', 'cancelled', 'expired');
CREATE TYPE trade_type AS ENUM ('buy', 'sell');
CREATE TYPE market_status AS ENUM ('active', 'paused', 'resolved', 'canceled');

-- ê³µê°œ ìŠ¤í‚¤ë§ˆ (ì£¼ ë°ì´í„°)
CREATE SCHEMA public;

-- ì‚¬ìš©ì í…Œì´ë¸”
CREATE TABLE public.users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    address VARCHAR(42) UNIQUE NOT NULL,
    ens_name VARCHAR(255),
    avatar_url VARCHAR(512),
    bio TEXT,
    username VARCHAR(50) UNIQUE,
    follower_count INTEGER DEFAULT 0,
    following_count INTEGER DEFAULT 0,
    trading_volume_total NUMERIC(36, 8) DEFAULT 0,
    realized_pnl_total NUMERIC(36, 8) DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_address ON public.users(address);
CREATE INDEX idx_users_username ON public.users(username);

-- ì‹œì¥ í…Œì´ë¸”
CREATE TABLE public.markets (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    address VARCHAR(42) UNIQUE NOT NULL,
    question TEXT NOT NULL,
    description TEXT,
    outcomes TEXT[] NOT NULL,
    outcome_count INTEGER NOT NULL,
    category VARCHAR(100),
    status market_status DEFAULT 'active',
    creator_address VARCHAR(42) NOT NULL,
    oracle_type VARCHAR(50) DEFAULT 'UMA',
    resolution_date TIMESTAMPTZ,
    settled_at TIMESTAMPTZ,
    settled_outcome INTEGER,
    volume NUMERIC(36, 8) DEFAULT 0,
    liquidity NUMERIC(36, 8) DEFAULT 0,
    trader_count INTEGER DEFAULT 0,
    creation_timestamp TIMESTAMPTZ DEFAULT NOW(),
    metadata JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_markets_address ON public.markets(address);
CREATE INDEX idx_markets_status ON public.markets(status);
CREATE INDEX idx_markets_category ON public.markets(category);
CREATE INDEX idx_markets_resolution_date ON public.markets(resolution_date);
CREATE INDEX idx_markets_volume ON public.markets(volume DESC);

-- ì˜¤ë” í…Œì´ë¸” (ì „ì²´ ì—­ì‚¬)
CREATE TABLE public.orders (
    id BIGSERIAL PRIMARY KEY,
    order_hash VARCHAR(66) UNIQUE NOT NULL,
    market_address VARCHAR(42) NOT NULL,
    maker_address VARCHAR(42) NOT NULL,
    outcome_index INTEGER NOT NULL,
    is_buy BOOLEAN NOT NULL,
    price NUMERIC(36, 18) NOT NULL,
    amount NUMERIC(36, 18) NOT NULL,
    filled_amount NUMERIC(36, 18) DEFAULT 0,
    status order_status DEFAULT 'open',
    nonce BIGINT NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    signature VARCHAR(256) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    cancelled_at TIMESTAMPTZ,
    expire_at TIMESTAMPTZ
);

CREATE INDEX idx_orders_market ON public.orders(market_address);
CREATE INDEX idx_orders_maker ON public.orders(maker_address);
CREATE INDEX idx_orders_status ON public.orders(status);
CREATE INDEX idx_orders_created_at ON public.orders(created_at DESC);
CREATE INDEX idx_orders_hash ON public.orders(order_hash);

-- ê±°ë˜ í…Œì´ë¸” (ì‹¤í–‰ëœ ê±°ë˜)
CREATE TABLE public.trades (
    id BIGSERIAL PRIMARY KEY,
    transaction_hash VARCHAR(66),
    market_address VARCHAR(42) NOT NULL,
    outcome_index INTEGER NOT NULL,
    price NUMERIC(36, 18) NOT NULL,
    amount NUMERIC(36, 18) NOT NULL,
    maker_address VARCHAR(42) NOT NULL,
    taker_address VARCHAR(42) NOT NULL,
    maker_order_hash VARCHAR(66) NOT NULL,
    taker_order_hash VARCHAR(66),
    fee NUMERIC(36, 8) DEFAULT 0,
    block_number BIGINT,
    log_index INTEGER,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_trades_market ON public.trades(market_address);
CREATE INDEX idx_trades_maker ON public.trades(maker_address);
CREATE INDEX idx_trades_taker ON public.trades(taker_address);
CREATE INDEX idx_trades_created_at ON public.trades(created_at DESC);
CREATE INDEX idx_trades_tx_hash ON public.trades(transaction_hash);

-- OHLCV ì°¨ëª©çƒ› í…Œì´ë¸” (ì°¨íŠ¸ ë°ì´í„°)
CREATE TABLE public.candles (
    id BIGSERIAL PRIMARY KEY,
    market_address VARCHAR(42) NOT NULL,
    outcome_index INTEGER DEFAULT 0,
    resolution VARCHAR(10) NOT NULL,
    open NUMERIC(36, 18) NOT NULL,
    high NUMERIC(36, 18) NOT NULL,
    low NUMERIC(36, 18) NOT NULL,
    close NUMERIC(36, 18) NOT NULL,
    volume NUMERIC(36, 8) NOT NULL,
    trade_count INTEGER DEFAULT 0,
    timestamp TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(market_address, outcome_index, resolution, timestamp)
);

CREATE INDEX idx_candles_market_time ON public.candles(
    market_address, outcome_index, resolution, timestamp
);

-- ì‚¬ìš©ì í¬ì§€ì…˜ í…Œì´ë¸”
CREATE TABLE public.positions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_address VARCHAR(42) NOT NULL,
    market_address VARCHAR(42) NOT NULL,
    outcome_index INTEGER NOT NULL,
    quantity NUMERIC(36, 18) NOT NULL,
    avg_price NUMERIC(36, 18) NOT NULL,
    realized_pnl NUMERIC(36, 8) DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_address, market_address, outcome_index)
);

CREATE INDEX idx_positions_user ON public.positions(user_address);
CREATE INDEX idx_positions_market ON public.positions(market_address);

-- ì‚¬ìš©ì íŒ”ë¡œìš° í…Œì´ë¸”
CREATE TABLE public.user_follows (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    follower_address VARCHAR(42) NOT NULL,
    following_address VARCHAR(42) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(follower_address, following_address)
);

CREATE INDEX idx_user_follows_follower ON public.user_follows(follower_address);
CREATE INDEX idx_user_follows_following ON public.user_follows(following_address);

-- í† ë¡  í…Œì´ë¸”
CREATE TABLE public.discussions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    market_address VARCHAR(42),
    user_address VARCHAR(42) NOT NULL,
    parent_id UUID,
    content TEXT NOT NULL,
    like_count INTEGER DEFAULT 0,
    reply_count INTEGER DEFAULT 0,
    is_edited BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_discussions_market ON public.discussions(market_address);
CREATE INDEX idx_discussions_user ON public.discussions(user_address);

-- í¬ëŸ¼ íˆ¬í‘œ í…Œì´ë¸”
CREATE TABLE public.forum_votes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_address VARCHAR(42) NOT NULL,
    thread_id UUID NOT NULL,
    vote_type INTEGER NOT NULL CHECK (vote_type IN (-1, 0, 1)),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_address, thread_id)
);

-- ì„¸ì…˜ í…Œì´ë¸” (JWT í† í°)
CREATE TABLE public.sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES public.users(id) ON DELETE CASCADE,
    token VARCHAR(512) NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_sessions_token ON public.sessions(token);
CREATE INDEX idx_sessions_user ON public.sessions(user_id);
```

### 6.2 ë·° ë° í•¨ìˆ˜

```sql
-- ë¦¬ë”ë³´ë“œ ë·°
CREATE VIEW public.leaderboard AS
SELECT
    address,
    trading_volume_total,
    realized_pnl_total,
    follower_count,
    created_at,
    RANK() OVER (ORDER BY trading_volume_total DESC) as volume_rank,
    RANK() OVER (ORDER BY realized_pnl_total DESC) as pnl_rank
FROM public.users
ORDER BY trading_volume_total DESC;

-- ì—…ë°ì´íŠ¸ íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ìë™ updated_at íŠ¸ë¦¬ê±°
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON public.users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER update_markets_updated_at
    BEFORE UPDATE ON public.markets
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- ì‹œì¥ ê±°ë˜ëŸ‰ ê³„ì‚° í•¨ìˆ˜
CREATE OR REPLACE FUNCTION calculate_market_volume(market_addr VARCHAR)
RETURNS NUMERIC AS $$
SELECT COALESCE(SUM(amount * price), 0)
FROM public.trades
WHERE market_address = market_addr;
$$ LANGUAGE sql;

-- ë‚ ì§œë³„ ê±°ë˜ íŒŒí‹°ì…˜ ìƒì„± í•¨ìˆ˜
CREATE OR REPLACE FUNCTION create_trade_partition()
RETURNS TRIGGER AS $$
DECLARE
    partition_name TEXT;
    start_date TEXT;
    end_date TEXT;
BEGIN
    start_date := TO_CHAR(DATE_TRUNC('month', NEW.created_at), 'YYYY_MM');
    partition_name := 'trades_' || start_date;

    IF NOT EXISTS (
        SELECT 1 FROM pg_class c
        JOIN pg_namespace n ON n.oid = c.relnamespace
        WHERE c.relname = partition_name
    ) THEN
        EXECUTE format(
            'CREATE TABLE %I PARTITION OF public.trades
             FOR VALUES FROM (%L) TO (%L)',
            partition_name,
            DATE_TRUNC('month', NEW.created_at),
            DATE_TRUNC('month', NEW.created_at) + INTERVAL '1 month'
        );
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER insert_trade_partition
    BEFORE INSERT ON public.trades
    FOR EACH ROW EXECUTE FUNCTION create_trade_partition();
```

---

## 7. ë°°í¬ ê°€ì´ë“œ

### 7.1 ì‚¬ì „ ìš”êµ¬ì‚¬í•­ ë° êµ¬ì„±

Foresight ë°°í¬ì—ëŠ” ì—¬ëŸ¬ ì¸í”„ë¼ êµ¬ì„± ìš”ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¸”ë¡ì²´ì¸ ìƒí˜¸ì‘ìš©ì„ ìœ„í•´ Polygon RPC(Alchemy ë˜ëŠ” Infura) ê³„ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì§€ì†ì  ì €ì¥ì„ ìœ„í•´ PostgreSQLê³¼ Redisê°€ í™œì„±í™”ëœ Supabase í”„ë¡œì íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤. Web3 ì¸ì¦ì„ ìœ„í•´ WalletConnect ê³„ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. Blockscoutê³¼ ê°™ì€ ì„œë¹„ìŠ¤ ì™¸ë¶€ ì¸ë±ì‹±ì„ ìœ„í•œ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.

```bash
# í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜
export PRIVATE_KEY=your_deployer_private_key
export RPC_URL=https://polygon-mainnet.infura.io/v3/YOUR_PROJECT_ID
export RPC_AMOY_URL=https://rpc-amoy.polygon.technology

export NEXT_PUBLIC_CHAIN_ID=137
export NEXT_PUBLIC_CHAIN_NAME=Polygon
export NEXT_PUBLIC_RPC_URL=https://polygon-rpc.com

export DATABASE_URL=postgresql://user:password@host:5432/foresight
export REDIS_URL=redis://user:password@host:6379

export NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID=your_project_id

export UMA_OPTIMISTIC_ORACLE=0x...
export UMA_FINDER=0x...
export UMA_COLLATERAL_TOKEN=0x...
```

### 7.2 ìŠ¤ë§ˆíŠ¸ ê³„ì•½ ë°°í¬

```bash
# ê³„ì•½ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd packages/contracts

# ì˜ì¡´ì„± ì„¤ì¹˜
npm install

# hardhat.config.tsì—ì„œ ë„¤íŠ¸ì›Œí¬ êµ¬ì„±
# ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒ ì„¹ì…˜ ì°¸ì¡°

# ê³„ì•½ ì»´íŒŒì¼
npx hardhat compile

# Polygonscanì—ì„œ ê³„ì•½ ê²€ì¦ (ì„ íƒì )
npx hardhat verify --network polygon 0xCONTRACT_ADDRESS

# Amoyì— ë°°í¬ (í…ŒìŠ¤íŠ¸ë„·)
npx hardhat run scripts/deploy_offchain_sprint1.ts --network amoy

# ê²€ì¦ í›„ Mainnetì— ë°°í¬
npx hardhat run scripts/deploy_offchain_sprint1.ts --network polygon
```

```typescript
// hardhat.config.ts

import { HardhatUserConfig } from "hardhat/config";
import "@nomicfoundation/hardhat-toolbox";
import "hardhat-deploy";
import "dotenv/config";

const config: HardhatUserConfig = {
  solidity: {
    version: "0.8.24",
    settings: {
      optimizer: {
        enabled: true,
        runs: 200,
      },
      viaIR: true,
    },
  },
  networks: {
    hardhat: {
      forking: {
        url: process.env.RPC_URL || "",
        blockNumber: 45000000,
      },
    },
    amoy: {
      url: process.env.RPC_AMOY_URL || "https://rpc-amoy.polygon.technology",
      chainId: 80002,
      accounts: [process.env.PRIVATE_KEY || ""].filter(Boolean),
      verify: {
        etherscan: {
          apiKey: process.env.POLYGONSCAN_API_KEY,
        },
      },
    },
    polygon: {
      url: process.env.RPC_URL || "https://polygon-rpc.com",
      chainId: 137,
      accounts: [process.env.PRIVATE_KEY || ""].filter(Boolean),
      verify: {
        etherscan: {
          apiKey: process.env.POLYGONSCAN_API_KEY,
        },
      },
    },
  },
  namedAccounts: {
    deployer: 0,
    admin: 1,
  },
  etherscan: {
    apiKey: process.env.POLYGONSCAN_API_KEY,
  },
};

export default config;
```

### 7.3 í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬

```bash
# ì›¹ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd apps/web

# ì˜ì¡´ì„± ì„¤ì¹˜
npm install

# í™˜ê²½ ë³€ìˆ˜ êµ¬ì„±
cp .env.example .env.local
# .env.localì„ ê°’ìœ¼ë¡œ í¸ì§‘

# í”„ë¡œë•ì…˜ ë¹Œë“œ
npm run build

# Vercelì— ë°°í¬
vercel deploy --prod

# ë˜ëŠ” ì„œë²„ì— ìˆ˜ë™ ë°°í¬
npm run start
```

### 7.4 Relayer ì„œë¹„ìŠ¤ ë°°í¬

```bash
# Relayer ë””ë ‰í† ë¦¬ë¡œ ì´ë™
cd services/relayer

# ì˜ì¡´ì„± ì„¤ì¹˜
npm install

# êµ¬ì„±
cp .env.example .env
# .envë¥¼ ê°’ìœ¼ë¡œ í¸ì§‘

# ë¹Œë“œ
npm run build

# PM2ë¡œ ì‹œì‘
pm2 start ecosystem.config.js --env production

# ë˜ëŠ” Dockerë¡œ
docker build -t foresight-relayer .
docker run -d --name foresight-relayer foresight-relayer
```

```yaml
# ì „ì²´ ì¸í”„ë¼ë¥¼ ìœ„í•œ docker-compose.yml
version: "3.8"

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  relayer:
    build:
      context: ./services/relayer
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/foresight
      - PRIVATE_KEY=${PRIVATE_KEY}
    depends_on:
      - redis
      - db
    restart: unless-stopped

  frontend:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://relayer:3001
    depends_on:
      - relayer
    restart: unless-stopped

  db:
    image: supabase/postgres:15
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=postgres
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql

volumes:
  redis_data:
  pg_data:
```

### 7.5 DNS ë° SSL êµ¬ì„±

```bash
# ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ ìœ„í•œ nginx êµ¬ì„±

# /etc/nginx/sites-available/foresight
server {
    listen 80;
    server_name api.foresight.market;

    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name api.foresight.market;

    ssl_certificate /etc/letsencrypt/live/api.foresight.market/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.foresight.market/privkey.pem;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /socket.io {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
```

---

## 8. ë³´ì•ˆ ê·œë²”

### 8.1 ìŠ¤ë§ˆíŠ¸ ê³„ì•½ ë³´ì•ˆ

Foresightì˜ ìŠ¤ë§ˆíŠ¸ ê³„ì•½ì„œëŠ” ê°ì‚¬ë˜ì—ˆìœ¼ë©°åŒºå—é“¾ ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€ë¥¼ ë”°ë¦…ë‹ˆë‹¤. ê°ì‚¬ì—ëŠ” ë¦¬ì—”íŠ¸ë€ì‹œ ê³µê²©, ì •ìˆ˜ ì˜¤ë²„í”Œë¡œìš°, ì ‘ê·¼ ì œì–´ ì‹¤íŒ¨, í”„ë¡ íŠ¸ëŸ¬ë‹ ê³µê²©ê³¼ ê°™ì€ ì¼ë°˜ì ì¸ ì·¨ì•½ì ì— ëŒ€í•œ í˜•ì‹ì  ê²€ì¦ì´ í¬í•¨ë©ë‹ˆë‹¤. ê³„ì•½ì„œëŠ” ì»¤ë®¤ë‹ˆí‹°ì— ì˜í•´ ê´‘ë²”ìœ„í•˜ê²Œ ê°ì‚¬ëœ OpenZeppelin ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```solidity
// ê³„ì•½ì„œì—ì„œ ë¦¬ì—”íŠ¸ë€ì‹œ ë³´í˜¸ ì˜ˆì œ

abstract contract OffchainMarketBase is
    UUPSUpgradeable,
    ReentrancyGuardUpgradeable,
    EIP712Upgradeable
{
    modifier nonReentrant() {
        require(_status != _ENTERED, 'ReentrancyGuard: reentrant call');
        _status = _ENTERED;
        _;
        _status = _NOT_ENTERED;
    }

    // ìê¸ˆì„ ì´ì „í•˜ê±°ë‚˜ ì¤‘ìš”í•˜ê²Œ ìƒíƒœë¥¼ ìˆ˜ì •í•˜ëŠ”
    // ëª¨ë“  ì™¸ë¶€ í•¨ìˆ˜ëŠ” ì´ ìˆ˜ì •ìë¥¼ ì‚¬ìš©
    function fillOrder(
        Order calldata order,
        Signature calldata signature,
        uint128 fillAmount
    ) external override nonReentrant {
        // ì˜¤ë” ì±„ìš°ê¸° ë¡œì§
    }

    function claimWinnings() external nonReentrant {
        // ìˆ˜ìµ ì²­êµ¬ ë¡œì§
    }

    function withdraw(address token, uint256 amount) external nonReentrant {
        // ì¶œê¸ˆ ë¡œì§
    }
}
```

### 8.2 ê³µê²©ìœ¼ë¡œë¶€í„°ì˜ ë³´í˜¸

ì‹œìŠ¤í…œì€ ì‹œì¥ ì¡°ì‘ ë° ì¬ì •ì  ê³µê²©ì— ëŒ€í•œ ì—¬ëŸ¬ ë³´í˜¸ ë ˆì´ì–´ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. í”„ë¡ íŠ¸ëŸ¬ë‹ ë³´í˜¸ëŠ” ìµœì†Œ ì§€ì—° ë° ìŠ¬ë¦¬í”¼ì§€ í—ˆìš© ë©”ì»¤ë‹ˆì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ê³µê²©ì„ ê²½ì œì ìœ¼ë¡œ ì‹¤í–‰ ë¶ˆê°€ëŠ¥í•˜ê²Œ ë§Œë“­ë‹ˆë‹¤. ì˜¤ë”ëŠ” í•œë„ ê°€ê²© ë˜ëŠ” ê·¸ ì´ìƒì—ì„œ ì‹¤í–‰ë˜ì–´, ì‚¬ìš©ìê°€ ë™ì˜í•œ ê°€ê²©ì„ ìµœì†Œí•œ ì–»ì„ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤. RelayerëŠ” ìŠ¤í‘¸í•‘ ì˜¤ë”ë‚˜ ì„¸íƒ ê±°ë˜ íŒ¨í„´ê³¼ ê°™ì€ ì‹œì¥ ì¡°ì‘ ì‹œë„ë¥¼ íƒì§€í•˜ê³  ê±°ë¶€í•˜ëŠ” ì•ˆí‹°ê²Œì´ë° í†µì œë„ êµ¬í˜„í•©ë‹ˆë‹¤.

```typescript
// Relayerì˜ ìŠ¬ë¦¬í”¼ì§€ ë³´í˜¸

interface SlippageConfig {
  defaultPercentage: number;
  maxPercentage: number;
  dynamicAdjustment: boolean;
}

export function calculateSlippageProtection(
  orderPrice: bigint,
  marketVolatility: number,
  config: SlippageConfig
): bigint {
  let slippagePercent = config.defaultPercentage;

  if (config.dynamicAdjustment) {
    // ë³€ë™ì„± ë†’ì€ ì‹œì¥ì˜ ìŠ¬ë¦¬í”¼ì§€ ì¦ê°€
    const volatilityAdjustment = Math.min(marketVolatility * 2, 5);
    slippagePercent += volatilityAdjustment;
  }

  // ìµœëŒ€ ìŠ¬ë¦¬í”¼ì§€ ì œí•œ
  slippagePercent = Math.min(slippagePercent, config.maxPercentage);

  // í•œë„ ê°€ê²© ê³„ì‚°
  const slippageAmount = (orderPrice * BigInt(slippagePercent)) / 100n;
  return orderPrice - slippageAmount;
}

export function validateSlippage(
  executedPrice: bigint,
  orderPrice: bigint,
  maxSlippagePrice: bigint
): boolean {
  // ì‹¤í–‰ ê°€ê²©ì´ í—ˆìš© ë²”ìœ„ ë‚´ì¸ì§€ í™•ì¸
  if (executedPrice > orderPrice) {
    // ë§¤ìˆ˜ ê°€ê²©: ì‹¤í–‰ì´ í•œë„ ê°€ê²©ì„ ì´ˆê³¼í•´ì„œëŠ” ì•ˆ ë¨
    return executedPrice <= maxSlippagePrice;
  } else {
    // ë§¤ë„ ê°€ê²©: ì‹¤í–‰ì´ í•œë„ ê°€ê²©ë³´ë‹¤ ë‚®ì•„ì„œëŠ” ì•ˆ ë¨
    return executedPrice >= maxSlippagePrice;
  }
}
```

### 8.3 í”„ë¡ íŠ¸ì—”ë“œ ë³´ì•ˆ

í”„ë¡ íŠ¸ì—”ë“œ ì¸í„°í˜ì´ìŠ¤ëŠ” XSS, CSRF, ê¸°íƒ€ ì›¹ ê³µê²© ë²¡í„°ë¡œë¶€í„° ì‚¬ìš©ìë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ ì—„ê²©í•œ ë³´ì•ˆ ì¡°ì¹˜ë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤. ëª¨ë“  ì‚¬ìš©ì ì…ë ¥ì€ ì²˜ë¦¬ ë˜ëŠ” í‘œì‹œ ì „ì— ê²€ì¦ë˜ê³  ì‚´ê· ë©ë‹ˆë‹¤. ì¸ì¦ í† í°ì€ ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ë©° ì œí•œëœ ìˆ˜ëª…ì„ ê°€ì§‘ë‹ˆë‹¤.

```typescript
// ì…ë ¥ ê²€ì¦ ë° ì‚´ê· 

import { z } from "zod";

const orderSchema = z.object({
  outcome: z.number().int().min(0).max(7),
  isBuy: z.boolean(),
  price: z
    .string()
    .regex(/^\d+(\.\d+)?$/)
    .transform(Number),
  amount: z
    .string()
    .regex(/^\d+(\.\d+)?$/)
    .transform(Number),
  expires: z
    .number()
    .int()
    .min(1)
    .max(86400 * 7), // ìµœëŒ€ 7ì¼
  nonce: z.number().int().positive(),
});

export function validateAndSanitizeOrder(input: unknown) {
  const result = orderSchema.safeParse(input);
  if (!result.success) {
    throw new Error(`Validation failed: ${result.error.message}`);
  }
  return result.data;
}

// í‘œì‹œë¥¼ ìœ„í•œ XSS ë³´í˜¸
import DOMPurify from "isomorphic-dompurify";

function sanitizeContent(content: string): string {
  return DOMPurify.sanitize(content, {
    ALLOWED_TAGS: ["b", "i", "em", "strong", "a", "p", "br"],
    ALLOWED_ATTR: ["href", "title"],
  });
}
```

### 8.4 ë ˆì´íŠ¸ ë¦¬ë°‹ ë° DDoS ë³´í˜¸

```typescript
// ë ˆì´íŠ¸ ë¦¬ë°‹ ë¯¸ë“¤ì›¨ì–´

import { Ratelimit } from "@upstash/ratelimit";
import { Redis } from "@upstash/redis";

// API ì—”ë“œí¬ì¸íŠ¸ìš© ë ˆì´íŠ¸ ë¦¬ë¯¸í„°
const ratelimit = new Ratelimit({
  redis: new Redis({
    url: process.env.REDIS_URL!,
    token: process.env.REDIS_TOKEN!,
  }),
  limiter: Ratelimit.slidingWindow(60, "1 m"),
  analytics: true,
  prefix: "ratelimit:api",
});

export async function withRateLimit(
  request: Request,
  identifier: string,
  limit: number = 60
): Promise<Response | null> {
  const { success, remaining, reset } = await ratelimit.limit(identifier);

  if (!success) {
    return new Response("Too Many Requests", {
      status: 429,
      headers: {
        "X-RateLimit-Limit": limit.toString(),
        "X-RateLimit-Remaining": "0",
        "X-RateLimit-Reset": reset.toString(),
        "Retry-After": "60",
      },
    });
  }

  return null;
}

// ê³µê°œ ì—”ë“œí¬ì¸íŠ¸ìš© IPë³„ ë ˆì´íŠ¸ ë¦¬ë¯¸í„°
const ipRatelimit = new Ratelimit({
  redis: new Redis({ url: process.env.REDIS_URL!, token: process.env.REDIS_TOKEN! }),
  limiter: Ratelimit.slidingWindow(120, "1 m"),
  prefix: "ratelimit:ip",
});
```

---

## 9. í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

### 9.1 ìŠ¤ë§ˆíŠ¸ ê³„ì•½ í…ŒìŠ¤íŠ¸

```typescript
// test/market.test.ts

import { expect } from "chai";
import { loadFixture } from "@nomicfoundation/hardhat-network-helpers";
import { ethers } from "hardhat";
import { SignerWithAddress } from "@nomiclabs/hardhat-ethers/signers";

describe("OffchainMarket", function () {
  let marketFactory: any;
  let market: any;
  let owner: SignerWithAddress;
  let user1: SignerWithAddress;
  let user2: SignerWithAddress;
  let outcomeToken: any;

  async function deployMarketFixture() {
    const [owner, user1, user2] = await ethers.getSigners();

    const OutcomeToken = await ethers.getContractFactory("OutcomeToken1155");
    outcomeToken = await OutcomeToken.deploy();
    await outcomeToken.deployed();

    const MarketFactory = await ethers.getContractFactory("MarketFactory");
    marketFactory = await MarketFactory.deploy();
    await marketFactory.deployed();

    const templateBinary = await ethers.deployContract("OffchainBinaryMarket");
    const templateMulti = await ethers.deployContract("OffchainMultiMarket8");

    await marketFactory.initialize(
      templateBinary.address,
      templateMulti.address,
      outcomeToken.address
    );

    // í…ŒìŠ¤íŠ¸ ì‹œì¥ ìƒì„±
    const tx = await marketFactory.createMarket(
      {
        question: "Will Bitcoin exceed $100,000 by end of 2025?",
        outcomes: ["Yes", "No"],
        resolutionDate: Math.floor(Date.now() / 1000) + 86400 * 30,
        resolutionReward: ethers.utils.parseEther("1000"),
        oracle: ethers.constants.AddressZero,
        useUMA: false,
      },
      "crypto"
    );

    const receipt = await tx.wait();
    const marketAddress = receipt.events[0].args.marketAddress;

    market = await ethers.getContractAt("OffchainBinaryMarket", marketAddress);

    return { market, owner, user1, user2, outcomeToken };
  }

  beforeEach(async function () {
    const fixture = await loadFixture(deployMarketFixture);
    market = fixture.market;
    owner = fixture.owner;
    user1 = fixture.user1;
    user2 = fixture.user2;
    outcomeToken = fixture.outcomeToken;
  });

  describe("Order Placement", function () {
    it("Should allow placing a buy order", async function () {
      const order = {
        maker: user1.address,
        outcome: 0,
        isBuy: true,
        price: ethers.utils.parseEther("0.65"),
        amount: ethers.utils.parseEther("100"),
        expires: Math.floor(Date.now() / 1000) + 3600,
        nonce: 1,
      };

      const domain = {
        name: "Foresight Market",
        version: "1",
        chainId: (await ethers.provider.getNetwork()).chainId,
        verifyingContract: market.address,
      };

      const signature = await user1._signTypedData(domain, { Order: order }, order);

      await expect(market.connect(user2).placeOrder(order, signature)).to.emit(
        market,
        "OrderPlaced"
      );
    });

    it("Should reject orders with invalid signature", async function () {
      const order = {
        maker: user1.address,
        outcome: 0,
        isBuy: true,
        price: ethers.utils.parseEther("0.65"),
        amount: ethers.utils.parseEther("100"),
        expires: Math.floor(Date.now() / 1000) + 3600,
        nonce: 1,
      };

      const invalidSignature = {
        v: 27,
        r: "0x" + "11".repeat(32),
        s: "0x" + "22".repeat(32),
      };

      await expect(market.connect(user2).placeOrder(order, invalidSignature)).to.be.revertedWith(
        "Invalid signature"
      );
    });

    it("Should reject expired orders", async function () {
      const order = {
        maker: user1.address,
        outcome: 0,
        isBuy: true,
        price: ethers.utils.parseEther("0.65"),
        amount: ethers.utils.parseEther("100"),
        expires: Math.floor(Date.now() / 1000) - 1, // ë§Œë£Œë¨
        nonce: 1,
      };

      // ìœ íš¨í•œ ì„œëª…ì´ì§€ë§Œ ë§Œë£Œëœ ì˜¤ë”
      // "Order expired"ë¡œ ì‹¤íŒ¨í•´ì•¼ í•¨
    });
  });

  describe("Order Matching", function () {
    it("Should match buy and sell orders at crossing prices", async function () {
      // 0.70ì— ë§¤ìˆ˜ ì˜¤ë” ë°°ì¹˜
      const buyOrder = {
        maker: user1.address,
        outcome: 0,
        isBuy: true,
        price: ethers.utils.parseEther("0.70"),
        amount: ethers.utils.parseEther("100"),
        expires: Math.floor(Date.now() / 1000) + 3600,
        nonce: 1,
      };

      // 0.65ì— ë§¤ë„ ì˜¤ë” ë°°ì¹˜ (êµì°¨ ê°€ê²©)
      const sellOrder = {
        maker: user2.address,
        outcome: 0,
        isBuy: false,
        price: ethers.utils.parseEther("0.65"),
        amount: ethers.utils.parseEther("100"),
        expires: Math.floor(Date.now() / 1000) + 3600,
        nonce: 1,
      };

      // ì„œëª…ë“¤...

      // 0.65( maker ê°€ê²©)ë¡œ ì‹¤í–‰ ì„±ê³µí•´ì•¼ í•¨
    });

    it("Should not match orders at non-crossing prices", async function () {
      // 0.50ì— ë§¤ìˆ˜, 0.70ì— ë§¤ë„
      // ë§¤ì¹­ë˜ì§€ ì•Šì•„ì•¼ í•¨
    });
  });
});
```

### 9.2 í”„ë¡ íŠ¸ì—”ë“œ í†µí•© í…ŒìŠ¤íŠ¸

```typescript
// apps/web/tests/trading.spec.ts

import { test, expect } from "@playwright/test";

test.describe("Trading Interface", () => {
  test.beforeEach(async ({ page }) => {
    // í…ŒìŠ¤íŠ¸ ì§€ê°‘ ì—°ê²°
    await page.goto("/");
    await page.click('[data-testid="connect-wallet"]');
    // ëª¨ì˜ ì§€ê°‘ êµ¬ì„±...
  });

  test("should display order form correctly", async ({ page }) => {
    await page.goto("/markets/0x1234...5678");

    // ì˜¤ë” í¼ ì¡´ì¬ í™•ì¸
    await expect(page.locator('[data-testid="order-form"]')).toBeVisible();
    await expect(page.locator('[data-testid="buy-button"]')).toBeVisible();
    await expect(page.locator('[data-testid="sell-button"]')).toBeVisible();
  });

  test("should allow placing a buy order", async ({ page }) => {
    await page.goto("/markets/0x1234...5678");

    // í¼ ì‘ì„±
    await page.fill('[data-testid="price-input"]', "0.65");
    await page.fill('[data-testid="amount-input"]', "100");
    await page.click('[data-testid="buy-button"]');

    // ì œì¶œ í™•ì¸
    await expect(page.locator('[data-testid="order-success"]')).toBeVisible();
  });

  test("should update order book in real-time", async ({ page }) => {
    await page.goto("/markets/0x1234...5678");

    // ì´ˆê¸° ì˜¤ë”ë¶ í™•ì¸
    const initialOrders = await page.locator('[data-testid="order-book-row"]').count();

    // ë‹¤ë¥¸ ê³„ì •ì—ì„œ ì˜¤ë” ë°°ì¹˜ (ëª¨ì˜)
    // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™•ì¸
    await expect(page.locator('[data-testid="order-book-row"]')).toHaveCount(initialOrders + 1);
  });
});
```

### 9.3 Relayer ë¶€í•˜ í…ŒìŠ¤íŠ¸

```typescript
// services/relayer/test/load.test.ts

import { k6 } from "k6";

export const options = {
  stages: [
    { duration: "2m", target: 100 }, // ë¨í”„ì—…
    { duration: "5m", target: 500 }, // ê³ ë¶€í•˜
    { duration: "5m", target: 1000 }, // ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸
    { duration: "2m", target: 0 }, // ë¨í”„ë‹¤ìš´
  ],
  thresholds: {
    http_req_duration: ["p(95)<500"],
    http_req_failed: ["rate<0.01"],
  },
};

export default function () {
  const order = generateRandomOrder();

  const res = http.post(`${BASE_URL}/api/orders`, JSON.stringify(order), {
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${authToken}`,
    },
  });

  check(res, {
    "order accepted": (r) => r.status === 200,
    "response time < 200ms": (r) => r.timings.duration < 200,
  });
}

function generateRandomOrder() {
  return {
    outcome: Math.floor(Math.random() * 2),
    isBuy: Math.random() > 0.5,
    price: (Math.random() * 0.5 + 0.25).toString(),
    amount: (Math.random() * 1000 + 100).toString(),
    expires: Math.floor(Date.now() / 1000) + 3600,
    nonce: Date.now(),
  };
}
```

---

## 10. ë¬¸ì œ í•´ê²°

### 10.1 ì¼ë°˜ì ì¸ ë¬¸ì œ ë° í•´ê²°ì±…

**ì˜¤ë¥˜: "Insufficient gas" ë˜ëŠ” íŠ¸ëœì­ì…˜ ì‹¤íŒ¨**

ì´ ì˜¤ë¥˜ëŠ” ì¼ë°˜ì ìœ¼ë¡œ ê°€ìŠ¤ ì¶”ì •ì´ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ê°€ìŠ¤ ê°€ê²©ì´ ë„ˆë¬´ ë†’ì„ ë•Œ ë°œìƒí•©ë‹ˆë‹¤. ë¨¼ì € ê³„ì •ì— ê°€ìŠ¤ ë¹„ìš©ì„ ì¶©ì¡±í•  ì¶©ë¶„í•œ MATICì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ë‹¤ìŒìœ¼ë¡œ ì˜¤ë” ë§¤ê°œë³€ìˆ˜ê°€ ìœ íš¨í•œì§€ í™•ì¸í•©ë‹ˆë‹¤(ê°€ê²©ì€ 0ê³¼ 1 ì‚¬ì´, ìˆ˜ëŸ‰ì€ ì–‘ìˆ˜, ì‚¬ìš©ë˜ì§€ ì•Šì€ nonce). ë¬¸ì œê°€ ì§€ì†ë˜ë©´ Web3 í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê°€ìŠ¤ í•œë„ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ëŠ˜ë¦½ë‹ˆë‹¤.

**ì˜¤ë¥˜: "Order expired"**

ì˜¤ë”ì—ëŠ” ìœ íš¨ ê¸°ê°„ì´ ì œí•œë˜ì–´ ìˆìŠµë‹ˆë‹¤(ê¸°ë³¸ê°’ 1ì‹œê°„). ë§Œë£Œëœ íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ì˜¤ë”ë¥¼ ì œì¶œí•˜ë©´ ê±°ë¶€ë©ë‹ˆë‹¤. ì‹œìŠ¤í…œ ì‹œê°„ì„ í™•ì¸í•˜ê³  ë¯¸ë˜ ë§Œë£Œë¡œ ì˜¤ë”ë¥¼ ì¬ìƒì„±í•©ë‹ˆë‹¤. ì˜¤ë”ê°€ Relayer ìºì‹œì— ë„ˆë¬´ ì˜¤ë˜ ì €ì¥ëœ ê²½ìš° nonceë„ ë§Œë£Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**ì˜¤ë¥˜: "Nonce already used"**

ê° nonceëŠ” ì£¼ì†Œë‹¹ í•œ ë²ˆë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë¯¸ ì‚¬ìš©ëœ nonceë¡œ ì˜¤ë”ë¥¼ ì œì¶œí•˜ë ¤ê³  í•˜ë©´ ê±°ë¶€ë©ë‹ˆë‹¤. ìƒˆ ì˜¤ë”ë§ˆë‹¤ ì¦ê°€ëœ ìƒˆ nonceë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì‹œìŠ¤í…œì€ ë¦¬í”Œë ˆì´ ê³µê²©ì„é˜²æ­¢í•˜ê¸° ìœ„í•´ ì‚¬ìš©ëœ nonceë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.

**ì°¨íŠ¸ ë¡œë“œ ì•ˆë¨**

OHLCV ë°ì´í„°ê°€ í‘œì‹œë˜ì§€ ì•Šìœ¼ë©´ ì¸í„°ë„· ì—°ê²°ê³¼ API URLì„ í™•ì¸í•©ë‹ˆë‹¤. ì°¨íŠ¸ ë°ì´í„°ëŠ” ì„œë²„ ì¸¡ì—ì„œ ìºì‹œë˜ë©°, ìƒˆ ë°ì´í„°ì™€ APIë¥¼ í†µí•œ ê°€ìš©ì„± ì‚¬ì´ì— ëª‡ ë¶„ ì§€ì—°ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**WebSocket ì—°ê²° ë¬¸ì œ**

WebSocket ì—°ê²°ì€ ë°©í™”ë²½ì´ë‚˜ í”„ë¡ì‹œ ë„¤íŠ¸ì›Œí¬ì— ì˜í•´ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í”„ë¡ íŠ¸ì—”ë“œëŠ” ìë™ ì¬ì—°ê²°ì„ êµ¬í˜„í•˜ì§€ë§Œ, ë¬¸ì œê°€ ì§€ì†ë˜ë©´ Relayerìš© í¬íŠ¸ 3001(ë˜ëŠ” êµ¬ì„±ëœ í¬íŠ¸)ì´ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸í•©ë‹ˆë‹¤.

### 10.2 ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§

```bash
# ì‹¤ì‹œê°„ Relayer ë¡œê·¸
tail -f /var/log/foresight-relayer/app.log

# ë ˆë²¨ë³„ ë¡œê·¸ í•„í„°ë§
grep -E "ERROR|WARN" /var/log/foresight-relayer/app.log

# Prometheus ë©”íŠ¸ë¦­
curl http://localhost:3001/metrics

# ì„œë¹„ìŠ¤ ìƒíƒœ
curl http://localhost:3001/health
```

### 10.3 ì§„ë‹¨ ëª…ë ¹

```bash
# ê³„ì•½ ìƒíƒœ í™•ì¸
npx hardhat run scripts/verify-deployments.ts --network polygon

# Redis ë™ê¸°í™” í™•ì¸
redis-cli info | grep used_memory

# í™œì„± ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
psql -c "SELECT count(*) FROM pg_stat_activity;"

# API ì—°ê²°ì„± í…ŒìŠ¤íŠ¸
curl -v https://api.foresight.health

# ë§Œë£Œëœ í† í° í™•ì¸
npm run db:check-expired-sessions
```

### 10.4 ë³µêµ¬ ì ˆì°¨

ì¤‘ëŒ€ ì¥ì•  ì‹œ ë‹¤ìŒ ì ˆì°¨ë¥¼ í†µí•´ ì„œë¹„ìŠ¤ë¥¼ ë³µì›í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# Relayer ì¶©ëŒ í›„ ë³µêµ¬
pm2 restart foresight-relayer
pm2 logs foresight-relayer --lines 100

# ë°ì´í„°ë² ì´ìŠ¤ ì¶©ëŒ í›„ ë³µêµ¬
pg_restore -h localhost -U postgres -d foresigh backup.dump

# ë¸”ë¡ì²´ì¸ ë™ê¸°í™”ä¸æ­£ç¡® í›„ ë³µêµ¬
# ì•Œë ¤ì§„ ë¸”ë¡ì—ì„œ ì´ë²¤íŠ¸ ë¦¬í”Œë ˆì´
npm run relayer:sync -- --from-block 45000000

# ì™„ì „ ì¬ì„¤ì • (DEV ONLY)
npm run db:reset
npm run redis:flushall
npm run contracts:redeploy
```

---

## ì¶”ê°€ ë¦¬ì†ŒìŠ¤

| ë¦¬ì†ŒìŠ¤              | ë§í¬                                    |
| ------------------- | --------------------------------------- |
| Next.js ë¬¸ì„œ        | https://nextjs.org/docs                 |
| React Query ë¬¸ì„œ    | https://tanstack.com/query/latest       |
| ethers.js ë¬¸ì„œ      | https://docs.ethers.org/                |
| OpenZeppelin ê³„ì•½ì„œ | https://docs.openzeppelin.com/contracts |
| Polygon ë¬¸ì„œ        | https://wiki.polygon.technology/        |
| UMA í”„ë¡œí† ì½œ        | https://docs.uma.xyz/                   |
| EIP-712 í‘œì¤€        | https://eips.ethereum.org/EIPS/eip-712  |
| Supabase ë¬¸ì„œ       | https://supabase.com/docs               |
| Redis ë¬¸ì„œ          | https://redis.io/docs                   |

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-01-26

**ë²„ì „**: 3.0

---

**ì–¸ì–´ / Languages / è¯­è¨€åˆ‡æ¢ / Idioma / Langue:**

- [ğŸ“š DOCS.md](./DOCS.md) - English
- [ğŸ“š DOCS.zh-CN.md](./DOCS.zh-CN.md) - ç®€ä½“ä¸­æ–‡
- [ğŸ“š DOCS.es.md](./DOCS.es.md) - EspaÃ±ol
- [ğŸ“š DOCS.fr.md](./DOCS.fr.md) - FranÃ§ais
- [ğŸ“š DOCS.ko.md](./DOCS.ko.md) - í•œêµ­ì–´
